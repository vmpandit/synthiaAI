<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Synthia - AI Marketing Intelligence</title>
    <link rel="icon" type="image/png" href="synthia_icon_transparent.png">

    <!-- Fonts: Inter for premium readability -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Synthia - Responsive Premium Design */

        :root {
            --synthia-primary: #8B5CF6;
            --synthia-secondary: #A78BFA;
            --synthia-accent: #EC4899;
            --synthia-teal: #14B8A6;
            --synthia-gold: #F59E0B;
            --synthia-success: #10B981;

            --glass-thick: rgba(30, 30, 30, 0.6);
            --glass-thin: rgba(60, 60, 60, 0.3);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);

            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.85);
            --text-tertiary: rgba(255, 255, 255, 0.5);

            --radius-xl: 24px;
            --radius-l: 16px;
            --radius-m: 12px;
            --spacing-unit: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-primary);
            background: #000;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .liquid-background {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 15% 50%, rgba(139, 92, 246, 0.4), transparent 40%),
                radial-gradient(circle at 85% 30%, rgba(236, 72, 153, 0.35), transparent 40%),
                radial-gradient(circle at 50% 80%, rgba(167, 139, 250, 0.3), transparent 40%);
            filter: blur(60px);
            animation: liquid-move 20s ease-in-out infinite alternate;
        }

        @keyframes liquid-move {
            0% { transform: scale(1) translate(0, 0); }
            50% { transform: scale(1.1) translate(20px, -20px); }
            100% { transform: scale(1) translate(0, 0); }
        }

        .app-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px 80px;
        }

        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 40px;
            padding: 0 10px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .app-logo {
            width: 64px;
            height: 64px;
            object-fit: contain;
            filter: drop-shadow(0 0 15px rgba(139, 92, 246, 0.5));
            border-radius: 16px;
        }

        h1 {
            font-weight: 800;
            font-size: 3rem;
            letter-spacing: -0.03em;
            background: linear-gradient(135deg, var(--synthia-primary) 0%, var(--synthia-secondary) 50%, var(--synthia-accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            line-height: 1.1;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
            max-width: 680px;
            margin: 0 auto;
            line-height: 1.5;
        }

        .glass-panel {
            background: var(--glass-thick);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--glass-shadow);
            padding: 32px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
        }

        .glass-panel.collapsed {
            max-height: 80px;
            overflow: hidden;
            cursor: pointer;
            padding-bottom: 0;
        }

        .glass-panel.collapsed:hover { background: rgba(40, 40, 40, 0.7); }
        .glass-panel.collapsed #personaInputSection, .glass-panel.collapsed #personaSection { display: none !important; }

        .glass-panel::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.5), transparent);
        }

        .form-group { margin-bottom: 20px; }

        label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .label-with-help { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }

        .help-icon {
            width: 18px; height: 18px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 11px; color: var(--synthia-secondary);
            cursor: pointer;
        }

        input[type="text"], input[type="password"], input[type="url"], textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-m);
            padding: 14px 16px;
            color: white;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s ease;
            -webkit-appearance: none;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--synthia-primary);
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        textarea { min-height: 120px; resize: vertical; }

        .form-help { font-size: 0.8rem; color: var(--text-tertiary); margin-top: 6px; display: block; }

        .btn-primary {
            background: linear-gradient(135deg, var(--synthia-primary), var(--synthia-secondary));
            color: white;
            border: none;
            padding: 16px 24px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--radius-l);
            cursor: pointer;
            width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            min-height: 52px;
        }

        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-secondary {
            background: rgba(139, 92, 246, 0.15);
            color: white;
            border: 1px solid rgba(139, 92, 246, 0.3);
            padding: 12px 20px;
            border-radius: var(--radius-m);
            font-weight: 500;
            cursor: pointer;
            min-height: 44px;
            font-size: 0.95rem;
            transition: background 0.2s ease;
        }

        .btn-secondary:hover { background: rgba(139, 92, 246, 0.25); border-color: var(--synthia-primary); }

        .btn-text { background: none; border: none; color: var(--text-tertiary); text-decoration: underline; cursor: pointer; padding: 8px; }

        .upload-zone {
            border: 2px dashed rgba(139, 92, 246, 0.3);
            border-radius: var(--radius-l);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            background: rgba(139, 92, 246, 0.05);
            transition: border-color 0.2s;
        }
        .upload-zone:active { background: rgba(139, 92, 246, 0.1); border-color: var(--synthia-primary); }
        .upload-icon { font-size: 2.5rem; margin-bottom: 12px; display: block; }

        .preview-container { margin-top: 24px; border-radius: var(--radius-l); overflow: hidden; display: none; position: relative; }
        .preview-image { width: 100%; display: block; }

        .segmented-control {
            display: flex;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px;
            border-radius: var(--radius-m);
            margin-bottom: 24px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .segmented-control::-webkit-scrollbar { display: none; }

        .segment-btn {
            flex: 1;
            padding: 10px 14px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            white-space: nowrap;
            min-width: 75px;
        }

        .segment-btn.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.4), rgba(167, 139, 250, 0.4));
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .content-area { background: rgba(0, 0, 0, 0.25); border-radius: var(--radius-l); padding: 24px; min-height: 200px; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; gap: 12px; }
        .content-title { font-size: 1.1rem; font-weight: 600; color: white; }

        /* NEW: Content image display */
        .content-image-wrapper {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 24px;
            border-radius: var(--radius-l);
            overflow: hidden;
            border: 1px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        .content-image {
            width: 100%;
            display: block;
        }

        .content-text { font-size: 1rem; line-height: 1.7; color: rgba(255, 255, 255, 0.9); word-wrap: break-word; }
        .content-text h1, .content-text h2 { color: white; margin: 24px 0 12px; font-weight: 700; line-height: 1.3; }
        .content-text h3 { color: var(--synthia-secondary); margin: 20px 0 10px; font-size: 1.1rem; }
        .content-text p { margin-bottom: 16px; }
        .content-text ul, .content-text ol { margin-bottom: 16px; padding-left: 20px; }
        .content-text li { margin-bottom: 6px; }
        .content-text blockquote { border-left: 3px solid var(--synthia-primary); padding-left: 16px; margin: 16px 0; color: var(--text-tertiary); font-style: italic; }

        .loading-overlay { display: none; text-align: center; padding: 40px 20px; }
        .spinner { width: 36px; height: 36px; border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top-color: var(--synthia-primary); animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px);
            padding: 14px 24px; border-radius: 50px; color: white; font-weight: 500; font-size: 0.9rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 3000;
            width: max-content; max-width: 90%; text-align: center; border: 1px solid rgba(255,255,255,0.1);
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px;
        }
        .modal-overlay.show { display: flex; }

        .modal-content {
            background: #1a1a1a; border: 1px solid var(--glass-border);
            border-radius: var(--radius-l); width: 100%; max-width: 600px;
            max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .modal-header { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #1a1a1a; z-index: 10; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: white; }
        .modal-close { background: rgba(255,255,255,0.1); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-body { padding: 24px; }
        .modal-step { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .step-link { display: inline-block; margin-top: 8px; color: var(--synthia-secondary); text-decoration: none; font-weight: 500; font-size: 0.9rem; }

        .flex-row { display: flex; gap: 10px; }
        .collapse-btn { background: none; border: none; color: var(--text-tertiary); font-size: 1.5rem; transform: rotate(0deg); transition: transform 0.3s; padding: 0 10px; cursor: pointer; }
        .glass-panel.collapsed .collapse-btn { transform: rotate(180deg); }
        footer { text-align: center; padding: 40px; color: var(--text-tertiary); font-size: 0.85rem; }

        @media (max-width: 640px) {
            .app-container { padding: 20px 16px 60px; }
            h1 { font-size: 2.2rem; }
            .subtitle { font-size: 1rem; padding: 0 10px; }
            .glass-panel { padding: 20px; border-radius: 20px; }
            .app-logo { width: 48px; height: 48px; border-radius: 12px; }

            .content-header { flex-direction: column; align-items: flex-start; gap: 16px; }
            .content-header .flex-row { width: 100%; justify-content: space-between; }
            .btn-secondary { flex: 1; text-align: center; font-size: 0.9rem; padding: 10px; }

            .modal-content { max-height: 90vh; border-radius: 20px; }
            .modal-body { padding: 20px; }
            .segment-btn { font-size: 0.8rem; padding: 8px 10px; min-width: 65px; }
        }
    </style>
</head>
<body>
    <div class="liquid-background"></div>

    <div class="app-container">
        <header>
            <div class="logo-container">
                <img src="synthia_icon_transparent.png" alt="Synthia Logo" class="app-logo">
                <h1>Synthia</h1>
            </div>
            <p class="subtitle">Meet Synthia, your AI marketing intelligence platform that synthesizes legendary frameworks with your unique brand voice‚Äîtransforming every image into a complete content ecosystem.</p>
        </header>

        <div class="glass-panel" id="configPanel">
            <div class="content-header" style="flex-direction: row; justify-content: space-between; width: 100%;">
                 <h3 style="margin:0; font-size: 1.1rem; color: white;">Brand Configuration</h3>
                 <div style="display: flex; align-items: center; gap: 8px;">
                    <button id="resetPersonaBtn" class="btn-text" style="display:none; font-size: 0.85rem;">Reset</button>
                    <button class="collapse-btn" id="configCollapseBtn">‚åÑ</button>
                 </div>
            </div>

            <div id="personaInputSection">
                <div class="form-group">
                    <div class="label-with-help">
                        <label>üîë Gemini API Key</label>
                        <span class="help-icon" onclick="showApiKeyHelp()" title="Help">?</span>
                    </div>
                    <input type="password" id="apiKey" placeholder="Paste your AIza... key here">
                    <span class="form-help">Stored locally in your browser. Never sent to our servers.</span>
                </div>

                <div class="form-group">
                    <label>üåê Your Website URL</label>
                    <input type="url" id="websiteUrl" placeholder="https://yourbrand.com">
                </div>

                <div class="form-group">
                    <label>üë• Client Websites (Optional)</label>
                    <textarea id="clientWebsites" placeholder="https://client1.com&#10;https://client2.com" style="min-height: 80px;"></textarea>
                    <span class="form-help">Helps Synthia understand your target audience better.</span>
                </div>

                <button class="btn-primary" id="generatePersonaBtn">
                    <span>üéØ Start Research & Generate Persona</span>
                </button>
            </div>

            <div id="personaSection" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div class="content-header">
                    <div class="content-title">‚ú® Active Persona</div>
                    <div class="flex-row" style="width: auto;">
                        <button class="btn-secondary" onclick="refinePersona()">Refine</button>
                        <button class="btn-secondary" onclick="exportPersonaToPDF()">PDF</button>
                    </div>
                </div>
                <div class="content-text" id="personaContent" style="max-height: 300px; overflow-y: auto; padding-right: 8px;"></div>
            </div>
        </div>

        <div class="glass-panel">
            <div class="upload-zone" id="uploadArea">
                <div class="upload-icon">üì∏</div>
                <h3 style="color:white; margin-bottom:8px;">Drop Image Here</h3>
                <p style="color: var(--text-tertiary); font-size: 0.9rem;">or tap to browse library</p>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">

            <div class="preview-container" id="previewContainer">
                <img id="previewImage" class="preview-image">
                <button id="imageRemoveX" style="position:absolute; top:12px; right:12px; width:36px; height:36px; border-radius:50%; background:rgba(0,0,0,0.7); color:white; border:1px solid rgba(255,255,255,0.3); font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; z-index: 10;">√ó</button>
            </div>

            <div class="loading-overlay" id="loading">
                <div class="spinner"></div>
                <p id="loadingText" style="color: var(--text-secondary); font-weight: 500;">Analyzing scene...</p>
                <p id="retryText" style="color: var(--synthia-teal); font-size: 0.85rem; margin-top: 8px; display:none;"></p>
            </div>

            <button class="btn-primary" id="analyzeBtn" style="margin-top: 24px; display: none;">
                <span>üîç Analyze & Generate Content</span>
            </button>

            <button class="btn-secondary" id="resetImageBtn" style="margin-top: 16px; display: none; width: 100%; text-align: center;">
                <span>üîÑ Upload Different Photo</span>
            </button>
        </div>

        <div class="glass-panel" id="resultsSection" style="display: none;">
            <div class="segmented-control" id="tabs">
                <div class="segment-btn active" data-tab="persona">Persona</div>
                <div class="segment-btn" data-tab="story">Story</div>
                <div class="segment-btn" data-tab="marketing">Copy</div>
                <div class="segment-btn" data-tab="instagram">Social</div>
                <div class="segment-btn" data-tab="blog">Blog</div>
                <div class="segment-btn" data-tab="googleads">Ads</div>
                <div class="segment-btn" data-tab="podcast">Audio</div>
                <div class="segment-btn" data-tab="aeo">AEO</div>
            </div>

            <div class="content-area">
                <div class="content-header">
                    <div class="content-title" id="contentTitle">Persona Used</div>
                    <div class="flex-row">
                        <button class="btn-secondary" onclick="copyCurrentContent()">Copy</button>
                        <button class="btn-secondary" onclick="exportCurrentToPDF()">PDF</button>
                    </div>
                </div>

                <!-- NEW: Image display in content area -->
                <div id="contentImageContainer" style="display:none;"></div>

                <div class="content-text" id="activeContent"></div>
            </div>
        </div>

        <footer>
            Designed & Developed by Vivek Pandit using AI ‚ù§Ô∏è
        </footer>
    </div>

    <div class="modal-overlay" id="apiKeyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üîë API Key Setup</div>
                <button class="modal-close" onclick="closeApiKeyHelp()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--text-secondary); line-height: 1.5;">
                    Synthia requires a free Gemini API key to function.
                </p>
                <div class="modal-step">
                    <strong>1. Get Key</strong><br>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="step-link">Open Google AI Studio ‚Üó</a>
                </div>
                <div class="modal-step">
                    <strong>2. Create</strong><br>
                    <span style="color: var(--text-tertiary);">Click "Create API Key" in the dashboard.</span>
                </div>
                <div class="modal-step" style="border:none;">
                    <strong>3. Paste</strong><br>
                    <span style="color: var(--text-tertiary);">Copy the key (starts with "AIza") and paste it into Synthia.</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="interviewModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üß† Strategy Interview</div>
                <button class="modal-close" onclick="closeInterviewHelp()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 24px; color: var(--text-secondary); font-size: 0.95rem;">
                    Synthia has analyzed your site. Please clarify a few details to ensure accuracy.
                </p>
                <div id="interviewContainer"></div>
                <button class="btn-primary" id="submitInterviewBtn" style="margin-top: 32px;">
                    <span>‚ú® Generate Final Persona</span>
                </button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        let selectedFile = null;
        let imageBase64 = null;
        let customPersona = null;
        let generatedContent = {
            persona: '', story: '', marketing: '', instagram: '', 
            blog: '', googleads: '', podcast: '', aeo: ''
        };
        let activeTab = 'persona';
        let workingModel = null;
        let generatedQuestions = [];
        let isRefining = false; 

        const els = {
            apiKey: document.getElementById('apiKey'),
            websiteUrl: document.getElementById('websiteUrl'),
            clientWebsites: document.getElementById('clientWebsites'),
            generatePersonaBtn: document.getElementById('generatePersonaBtn'),
            configPanel: document.getElementById('configPanel'),
            configCollapseBtn: document.getElementById('configCollapseBtn'),
            personaSection: document.getElementById('personaSection'),
            personaContent: document.getElementById('personaContent'),
            personaInputSection: document.getElementById('personaInputSection'),
            resetPersonaBtn: document.getElementById('resetPersonaBtn'),
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            previewContainer: document.getElementById('previewContainer'),
            previewImage: document.getElementById('previewImage'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            resetImageBtn: document.getElementById('resetImageBtn'),
            imageRemoveX: document.getElementById('imageRemoveX'),
            loading: document.getElementById('loading'),
            loadingText: document.getElementById('loadingText'),
            retryText: document.getElementById('retryText'),
            resultsSection: document.getElementById('resultsSection'),
            activeContent: document.getElementById('activeContent'),
            contentTitle: document.getElementById('contentTitle'),
            toast: document.getElementById('toast'),
            tabs: document.getElementById('tabs'),
            apiKeyModal: document.getElementById('apiKeyModal'),
            interviewModal: document.getElementById('interviewModal'),
            interviewContainer: document.getElementById('interviewContainer'),
            submitInterviewBtn: document.getElementById('submitInterviewBtn'),
            contentImageContainer: document.getElementById('contentImageContainer')
        };

        function showApiKeyHelp() { els.apiKeyModal.classList.add('show'); document.body.style.overflow = 'hidden'; }
        function closeApiKeyHelp() { els.apiKeyModal.classList.remove('show'); document.body.style.overflow = 'auto'; }
        function closeInterviewHelp() { els.interviewModal.classList.remove('show'); }

        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('geminiApiKey');
            if(savedKey) els.apiKey.value = savedKey;

            const savedPersona = localStorage.getItem('customPersona');
            if(savedPersona) {
                customPersona = savedPersona;
                displayPersona(savedPersona);
                els.personaInputSection.style.display = 'none'; 
                els.personaSection.style.display = 'block'; 
                els.resetPersonaBtn.style.display = 'inline-block';
            }

            els.websiteUrl.value = localStorage.getItem('personaWebsite') || '';
            els.clientWebsites.value = localStorage.getItem('personaClients') || '';
        });

        els.apiKey.addEventListener('blur', (e) => { if(e.target.value.trim()) localStorage.setItem('geminiApiKey', e.target.value.trim()); });
        els.uploadArea.addEventListener('click', () => els.fileInput.click());
        els.uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); els.uploadArea.style.borderColor = 'var(--synthia-primary)'; });
        els.uploadArea.addEventListener('dragleave', () => { els.uploadArea.style.borderColor = 'rgba(139, 92, 246, 0.3)'; });
        els.uploadArea.addEventListener('drop', handleDrop);
        els.fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        els.generatePersonaBtn.addEventListener('click', () => startPersonaResearch(false));
        els.submitInterviewBtn.addEventListener('click', finalizePersonaGeneration);
        els.analyzeBtn.addEventListener('click', analyzeImage);
        els.tabs.addEventListener('click', handleTabClick);
        els.configCollapseBtn.addEventListener('click', () => { els.configPanel.classList.toggle('collapsed'); });

        els.resetImageBtn.addEventListener('click', resetImage);
        els.imageRemoveX.addEventListener('click', resetImage);

        els.resetPersonaBtn.addEventListener('click', () => {
            if(confirm('Reset persona?')) {
                localStorage.removeItem('customPersona');
                customPersona = null;
                els.personaSection.style.display = 'none';
                els.personaInputSection.style.display = 'block';
                els.resetPersonaBtn.style.display = 'none';
                els.configPanel.classList.remove('collapsed');
                showToast('Persona reset.');
            }
        });

        function handleDrop(e) {
            e.preventDefault();
            els.uploadArea.style.borderColor = 'rgba(139, 92, 246, 0.3)';
            if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
        }

        function handleFile(file) {
            if(!file) return;
            if(!file.type.startsWith('image/')) return showToast('Please upload an image file');
            if(file.size > 4 * 1024 * 1024) return showToast('Image must be under 4MB');

            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                els.previewImage.src = e.target.result;
                els.previewContainer.style.display = 'block';
                els.analyzeBtn.style.display = 'flex';
                els.resetImageBtn.style.display = 'block';
                els.uploadArea.style.display = 'none'; 

                imageBase64 = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }

        function resetImage() {
            selectedFile = null;
            imageBase64 = null;
            els.fileInput.value = '';
            els.previewImage.src = '';
            els.previewContainer.style.display = 'none';
            els.analyzeBtn.style.display = 'none';
            els.resetImageBtn.style.display = 'none';
            els.resultsSection.style.display = 'none';
            els.uploadArea.style.display = 'block';
            els.configPanel.classList.remove('collapsed');
            showToast('Image reset.');
        }

        function handleTabClick(e) {
            if(!e.target.classList.contains('segment-btn')) return;
            document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            activeTab = e.target.dataset.tab;

            const titles = { 
                persona: 'Persona Used', 
                story: 'Complete Story', 
                marketing: 'Marketing Copy', 
                instagram: 'Instagram Captions', 
                blog: 'Blog Post', 
                googleads: 'Google Ads', 
                podcast: 'Podcast Script',
                aeo: 'AEO Website Audit'
            };
            els.contentTitle.innerText = titles[activeTab];
            els.activeContent.innerHTML = marked.parse(generatedContent[activeTab] || 'Content not available');

            // NEW: Show/hide image based on active tab (don't show for persona tab)
            if(activeTab !== 'persona' && imageBase64) {
                els.contentImageContainer.style.display = 'block';
                els.contentImageContainer.innerHTML = '<div class="content-image-wrapper"><img src="data:image/' + selectedFile.type.split('/')[1] + ';base64,' + imageBase64 + '" class="content-image" alt="Analyzed Image"></div>';
            } else {
                els.contentImageContainer.style.display = 'none';
            }
        }

        async function startPersonaResearch(refining = false) {
            isRefining = refining;
            const apiKey = els.apiKey.value.trim();
            if(!apiKey) return showToast('Please enter your API key');
            const website = els.websiteUrl.value.trim();
            if(!website) return showToast('Please enter a website URL');

            setLoading(true, refining ? 'Analyzing current persona...' : 'Researching website...');
            els.generatePersonaBtn.disabled = true;

            try {
                const researchPrompt = `You are a world-class brand strategist.
I am providing you with a website URL to analyze: ${website}
${els.clientWebsites.value ? "Also consider these client examples: " + els.clientWebsites.value : ""}
${refining ? "The user wants to REFINE their existing persona. Ask deeper questions." : ""}

Your goal is to build a PERFECT buyer persona.
CRITICAL INSTRUCTIONS:
1. IDENTIFY THE EXACT COMPANY NAME. Do not guess. If the name is not 100% clear from the URL, YOU MUST ASK THE USER FOR THE EXACT NAME.
2. IDENTIFY THE EXACT PRODUCTS/SERVICES. If ambiguous, YOU MUST ASK.

Generate 3-5 specific, high-impact interview questions.
If you are unsure of the Company Name, Question #1 MUST be: "What is the exact official name of your company?"

Return ONLY a raw JSON array of strings. Example: ["What is your company name?", "Who is your ideal customer?"]`;

                const result = await callGeminiAPI(apiKey, researchPrompt, null);

                let questions = [];
                try {
                    const cleanJson = result.replace(/```json|```/g, '').trim();
                    questions = JSON.parse(cleanJson);
                } catch (e) {
                    console.warn("JSON parse failed", e);
                    questions = result.split('\n').filter(q => q.includes('?'));
                }

                if(questions.length === 0) questions = ["What is your EXACT Company Name?", "What specific products do you sell?", "Who is your ideal customer?"];

                els.interviewContainer.innerHTML = '';
                questions.forEach((q, index) => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '20px';
                    div.innerHTML = `<label style="color:var(--synthia-teal); margin-bottom:8px; display:block;">${q}</label><textarea id="answer_${index}" placeholder="Type your answer..." style="min-height:80px;"></textarea>`;
                    els.interviewContainer.appendChild(div);
                });

                generatedQuestions = questions;
                setLoading(false);
                els.interviewModal.classList.add('show');

            } catch(err) {
                showToast('Error: ' + err.message);
                setLoading(false);
                els.generatePersonaBtn.disabled = false;
            }
        }

        function refinePersona() {
            if(confirm('Refine persona with new questions?')) startPersonaResearch(true);
        }

        async function finalizePersonaGeneration() {
            const apiKey = els.apiKey.value.trim();
            const website = els.websiteUrl.value.trim();
            const clients = els.clientWebsites.value.trim();

            let interviewTranscript = "";
            generatedQuestions.forEach((q, index) => {
                const answer = document.getElementById(`answer_${index}`).value.trim();
                if(answer) interviewTranscript += `Q: ${q}\nA: ${answer}\n\n`;
            });

            els.interviewModal.classList.remove('show');
            setLoading(true, 'Synthesizing persona...');

            try {
                const fullPrompt = `You are a world-class marketing strategist.
WEBSITE: ${website}
INTERVIEW: ${interviewTranscript}

Based on this, create a COMPREHENSIVE BUYER PERSONA (1000+ words).
CRITICAL: 
1. ACCURACY IS PARAMOUNT. Use the exact Company Name from the interview answers or website. Do not hallucinate a generic name.
2. Prioritize the user's interview answers over web assumptions.

## 1. COMPANY PROFILE
- Exact Company Name
- Tagline
- Industry & Niche

## 2. BRAND VOICE & PERSONALITY
## 3. TARGET AUDIENCE
## 4. UNIQUE VALUE PROPOSITION
## 5. CONTENT STRATEGY
## 6. COMPETITIVE LANDSCAPE
## 7. MARKETING CHANNELS
## 8. CUSTOMER JOURNEY
## 9. OBJECTIONS & SOLUTIONS
## 10. BRAND GUIDELINES

Use markdown formatting. Be specific.`;

                const personaText = await callGeminiAPI(apiKey, fullPrompt, null);
                customPersona = personaText;
                displayPersona(personaText);

                localStorage.setItem('customPersona', personaText);
                localStorage.setItem('personaWebsite', website);
                localStorage.setItem('personaClients', clients);

                els.personaInputSection.style.display = 'none';
                els.personaSection.style.display = 'block';
                els.resetPersonaBtn.style.display = 'inline-block';
                els.configPanel.classList.add('collapsed');
                showToast('‚úÖ Persona Generated!');

            } catch(err) {
                showToast('Error: ' + err.message);
            } finally {
                setLoading(false);
                els.generatePersonaBtn.disabled = false;
            }
        }

        async function analyzeImage() {
            const apiKey = els.apiKey.value.trim();
            if(!apiKey) return showToast('Please enter API key');
            if(!imageBase64) return showToast('Upload image first');

            els.configPanel.classList.add('collapsed');
            setLoading(true, 'Starting analysis...');
            els.resultsSection.style.display = 'none';
            els.analyzeBtn.disabled = true;
            els.resetImageBtn.style.display = 'none'; 

            try {
                const pContext = customPersona ? 
                    `\n\n=== BRAND & AUDIENCE PERSONA (CRITICAL) ===\n${customPersona}\n=== END PERSONA ===\n\nINSTRUCTION: You MUST adopt the Brand Voice defined above. Every word you write must align with this persona, the company values, and the target audience's pain points. Do not be generic. Be the brand.\n\n` : '';

                const websiteUrl = els.websiteUrl.value.trim();

                const prompts = {
                    story: pContext + `You are Robert McKee, master of story structure, combined with the observational skills of a CSI detective.

Analyze this image and create a COMPELLING NARRATIVE STORY (800-1,200 words) using these frameworks:

1. THREE-ACT STRUCTURE (McKee):
   - Act 1: Setup (Who, What, Where, When - establish context)
   - Act 2: Confrontation (The challenge, conflict, or journey)
   - Act 3: Resolution (The outcome, transformation, or revelation)

2. HERO'S JOURNEY ELEMENTS:
   - Ordinary world ‚Üí Call to adventure ‚Üí Crossing threshold
   - Tests and trials ‚Üí Transformation ‚Üí Return with wisdom

3. CINEMATIC OBSERVATION:
   - Notice EVERY detail (lighting, colors, textures, expressions)
   - Environmental context and atmosphere
   - Emotional undertones and subtext
   - Background elements that tell a story

4. STORYTELLING TECHNIQUES:
   - Use sensory details (what you see, implied sounds/smells)
   - Create character depth (motivations, backstory hints)
   - Build tension and pacing
   - Include dialogue if people are present
   - Use metaphors and vivid language

## HOW TO USE THIS STORY
- **Blog Feature:** Use as a "Founder's Story" or "Customer Spotlight".
- **Email Newsletter:** Send as a Sunday narrative email to build connection.
- **Social Media:** Break into a 5-part LinkedIn carousel or Instagram Story series.
- **Brand Manifesto:** Use the themes here to refine your core mission statement.

OUTPUT FORMAT:
- Write in flowing narrative prose
- 800-1,200 words
- Divided into clear beginning, middle, end
- Make it engaging and visual
- Connect details to larger meaning`,

                    marketing: pContext + `You are David Ogilvy, Gary Halbert, and Eugene Schwartz combined. 

YOUR GOAL: Sell the product/service defined in the Persona, using the visual evidence in the image as PROOF.

## 1. HEADLINES (5 Variations)
Write 5 distinct headlines using Ogilvy's formulas, strictly tailored to the Persona's pain points:
   - "How to [Benefit] Even If [Objection]"
   - "The Secret of [Desire]"
   - "[Number] Ways to [Benefit]"
   - "Give Me [Time] and I'll [Promise]"
   - "[Benefit] or Your Money Back"

## 2. BODY COPY (PAS Framework)
Write a 600-word sales letter.
- **PROBLEM:** Start with a deep, visceral pain point from the Persona. Connect it to what is MISSING or WRONG in the image's "Before" state (implied).
- **AGITATE:** Twist the knife. Why is this problem ruining their business/life? Use emotional language from the Brand Voice.
- **SOLUTION:** Introduce the product/service (from Persona) as the hero. Use the image as VISUAL PROOF of the solution. Describe the image details as benefits.

## 3. USP & PROOF (Rosser Reeves)
- Extract 3 unique benefits from the image.
- Connect each to a specific feature in the Persona.
- Use "So That" logic: "This [Image Detail] means [Feature] so that you get [Benefit]."

## 4. INSTRUCTIONS FOR USE
- **Landing Page:** Use the Headline 1 and Body Copy for your main sales page.
- **Email Blast:** Use Headline 3 as the subject line and the Agitate section as the email body.
- **Direct Mail:** Print the image with Headline 2 overlay for a postcard.

OUTPUT FORMAT:
- Use Markdown.
- Be punchy, persuasive, and direct.
- NO generic "marketing speak". Use the specific industry terms from the Persona.`,

                    instagram: pContext + `You are Gary Vaynerchuk. You know that attention is the asset.

YOUR GOAL: Stop the scroll. Use the Persona's voice to talk to the Target Audience about this specific image.

## 1. THE "JAB, JAB, JAB, RIGHT HOOK" STRATEGY
Create 5 distinct captions. Each must have a specific purpose:

1. **The Storyteller (Jab):** A vulnerable, authentic personal story related to the image. No selling. Just connection. (150 words)
2. **The Value Drop (Jab):** Teach them something specific about the industry (from Persona) using the image as a diagram/example. (100 words)
3. **The Question (Jab):** Ask a polarizing or deep question related to the Persona's niche. (50 words)
4. **The Behind-the-Scenes (Jab):** "Real talk" about what was happening when this photo was taken. (100 words)
5. **The Hard Sell (Right Hook):** Direct call to action. "Click the link in bio because [Benefit from Persona]." (75 words)

## 2. STRATEGIC ELEMENTS
- **Hooks:** First sentence must be explosive. (e.g., "Stop doing this.", "I messed up.", "The truth about [Industry].")
- **Voice:** Use the exact slang/tone defined in the Persona.
- **Hashtags:** 3 sets of hashtags (Broad, Niche, Community-specific).

## 3. HOW TO USE
- **Carousel:** Use the "Value Drop" text as slide content.
- **Stories:** Post the image with the "Question" caption as a sticker.
- **Reel:** Read the "Storyteller" caption as a voiceover for a video version.

OUTPUT FORMAT:
- Clearly labeled sections.
- Emoji usage aligned with Brand Personality (High energy vs. Minimalist).`,

                    blog: pContext + `You are Neil Patel and Brian Dean. You care about Ranking, Traffic, and Authority.

YOUR GOAL: Write a "Skyscraper" blog post that anchors this image as a key visual asset.

## 1. SEO STRATEGY
- **Primary Keyword:** Identify the most valuable keyword from the Persona that matches this image.
- **Intent:** Is this Informational, Navigational, or Transactional? Write accordingly.

## 2. POST STRUCTURE (1,800+ Words)
- **H1 Title:** Viral + Keyword optimized. (e.g., "Why [Topic] is Dead (And What to Do Instead)")
- **Introduction:** Hook (APP Formula: Agree, Promise, Preview).
- **The "Meat":** 5-7 H2 headers. EACH header must address a specific pain point from the Persona.
  - *Integration:* Reference the image in the 2nd or 3rd section as a primary example. "As you can see in the photo above..."
- **Data & Authority:** Cite (simulated) statistics relevant to the Industry in the Persona.
- **Conclusion:** Summary + Strong Call to Action (CTA).

## 3. CONTENT UPGRADES
- Suggest a "Lead Magnet" that fits this post (e.g., Checklist, PDF) based on the Persona's services.

## 4. HOW TO USE
- **Publish:** Post to your WordPress/CMS.
- **Syndicate:** Post the H1 and Intro to LinkedIn Articles with a link back.
- **Newsletter:** Send the "Meat" section as a value-newsletter.

OUTPUT FORMAT:
- Markdown H1, H2, H3.
- Short paragraphs (1-3 sentences).
- Bullet points for readability.`,

                    googleads: pContext + `You are Perry Marshall. You believe in the 80/20 rule of ad spend.

YOUR GOAL: Create a high-intent Google Ads campaign for the products/services in the Persona.

## 1. CAMPAIGN STRATEGY
- **Target Audience:** Define exactly who we are targeting from the Persona (e.g., "CTOs at Series B startups" vs "New moms").
- **Intent:** Buying intent vs. Research intent.

## 2. AD COPY (15 Headlines + 4 Descriptions)
- **Headlines (30 chars):**
  - 5x Benefit (Direct value from Persona)
  - 5x Pain/Fear (Problem from Persona)
  - 5x Curiosity (Weird/Specific hook)
- **Descriptions (90 chars):**
  - Focus on the "Unique Mechanism" defined in the Persona.

## 3. EXTENSIONS
- **Sitelinks:** 4 deep links to specific pages mentioned in the Persona (About, Pricing, Case Studies).
- **Callouts:** 4 trust signals (e.g., "24/7 Support", "Award Winning").

## 4. IMAGE ASSET USAGE
- Explain exactly how to crop/edit the uploaded image for a Display Ad or Performance Max asset.

## 5. HOW TO USE
- **Setup:** Copy/paste these directly into Google Ads Editor.
- **A/B Test:** Run Headline Group A vs Group B for 2 weeks.

OUTPUT FORMAT:
- Table format for headlines (if possible) or clear lists.
- Strict character count adherence (simulated).`,

                    podcast: pContext + `You are Joe Rogan (Interviewer) and Ira Glass (Storyteller).

YOUR GOAL: Write a podcast script where the Host discusses the themes in the image, connecting them to the Brand's mission.

## 1. THE CONCEPT
- **Title:** Catchy episode title.
- **Format:** Solo monologue OR Interview (you decide based on Brand Voice).

## 2. THE SCRIPT (15 Minutes / 2,000 Words)
- **Intro (The Hook):** Start *in media res* with a story related to the image. "So I was looking at this photo of [Image Subject] and it hit me..."
- **The Problem:** Pivot to the Industry Pain Point (from Persona). Why is this common? Why does it suck?
- **The Epiphany:** Connect the solution (Company Product) to the story.
- **The Deep Dive:** unpack the "Why". Use the Persona's expertise.
- **The CTA:** Soft sell. "If you're feeling like [Problem], check us out."

## 3. AUDIO CUES
- Include [Sound Effect], [Music Swell], [Long Pause] directions to make it professional.

## 4. HOW TO USE
- **Record:** Read this verbatim or use it as detailed show notes.
- **Clip:** The "Intro" section is your social media teaser clip.

OUTPUT FORMAT:
- Script format (Speaker: Dialogue).
- Natural, conversational tone (fillers, "you know", etc., if matches Brand Voice).`,

                    aeo: pContext + `You are a world-class AEO (Answer Engine Optimization) Strategist.

YOUR GOAL: Audit the Brand's digital presence (based on URL/Persona) and the provided image to dominate AI answers (ChatGPT, Perplexity, Gemini).

## 1. THE AUDIT (10-Point Framework)
Analyze the Image + Persona + Website URL and provide:

1. **Content Optimization:** How to rewrite the homepage to be "AI-readable".
2. **Schema Markup:** Specific JSON-LD snippets for the *products* in the image.
3. **Technical Infrastructure:** Core Web Vitals targets for this specific industry.
4. **Topical Authority:** 5 "Pillar Pages" this brand needs to write to own their niche.
5. **User Intent:** 10 Questions valid customers ask AI about this industry.
6. **Content Format:** How to structure their FAQ page for BERT/NLP models.
7. **Competitive Analysis:** Who is likely winning AI answers now? (Guess based on industry).
8. **Measurement:** How to track "Share of Voice" in AI.
9. **Action Plan:** Week 1 vs Month 1 priorities.
10. **Risk Mitigation:** How to protect brand reputation in AI hallucinations.

## 2. THE "MISSING LINK"
- Explain specifically why *this image* is a valuable AEO asset. (e.g., "Alt text optimization", "Visual search readiness").

## 3. HOW TO IMPLEMENT
- **Dev Team:** Give the Schema section to developers.
- **Content Team:** Give the "Topical Authority" list to writers.
- **SEO Team:** Implement the Technical Infrastructure audit.

OUTPUT FORMAT:
- Professional Audit Report style.
- Actionable, bulleted lists.
- Code blocks for Schema.`
                };

                for (const [key, prompt] of Object.entries(prompts)) {
                    setLoading(true, `Generating ${key}...`);
                    generatedContent[key] = await callGeminiAPI(apiKey, prompt, imageBase64);
                    await new Promise(r => setTimeout(r, 1200)); 
                }

                els.resultsSection.style.display = 'block';
                document.querySelector('[data-tab="story"]').click();
                els.resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                els.resetImageBtn.style.display = 'block';
                showToast('‚úÖ Content generated!');

            } catch(err) {
                showToast('Error: ' + err.message);
                console.error(err);
                els.resetImageBtn.style.display = 'block';
            } finally {
                setLoading(false);
                els.analyzeBtn.disabled = false;
            }
        }

        async function callGeminiAPI(apiKey, prompt, imageBase64 = null) {
            if (workingModel) return executeGeneration(apiKey, workingModel, prompt, imageBase64);
            if (els.retryText) { els.retryText.style.display = 'block'; els.retryText.innerText = 'Discovering models...'; }

            try {
                const listResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if (!listResp.ok) throw new Error('Failed to list models');
                const listData = await listResp.json();

                let candidates = (listData.models || [])
                    .filter(m => m.supportedGenerationMethods?.includes('generateContent'))
                    .sort((a, b) => {
                        const score = n => n.includes('gemini-2.0') ? 100 : n.includes('1.5-pro') ? 90 : n.includes('1.5-flash') ? 80 : 0;
                        return score(b.name) - score(a.name);
                    });

                if (candidates.length === 0) candidates = [{ name: 'models/gemini-2.0-flash' }, { name: 'models/gemini-1.5-flash' }];

                for (const candidate of candidates) {
                    try {
                        const modelName = candidate.name.replace('models/', '');
                        const result = await executeGeneration(apiKey, modelName, prompt, imageBase64);
                        workingModel = modelName;
                        if(els.retryText) els.retryText.style.display = 'none';
                        return result;
                    } catch (e) { }
                }
                throw new Error('No compatible models found.');
            } catch (e) { return fallbackHardcodedGeneration(apiKey, prompt, imageBase64); }
        }

        async function executeGeneration(apiKey, modelName, prompt, imageBase64) {
            if (els.retryText) { els.retryText.style.display = 'block'; els.retryText.innerText = `Generating with ${modelName}...`; }
            const parts = [{ text: prompt }];
            if(imageBase64) parts.push({ inline_data: { mime_type: selectedFile.type, data: imageBase64 } });

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts }],
                    generationConfig: { temperature: 0.9, topK: 40, topP: 0.95, maxOutputTokens: 8192 }
                })
            });

            if(!response.ok) throw new Error((await response.json()).error?.message || 'API Error');
            return (await response.json()).candidates[0].content.parts[0].text;
        }

        async function fallbackHardcodedGeneration(apiKey, prompt, imageBase64) {
             const models = ['gemini-2.0-flash', 'gemini-1.5-flash', 'gemini-1.5-pro'];
             for (const m of models) {
                 try { return await executeGeneration(apiKey, m, prompt, imageBase64); } catch (e) { }
             }
             throw new Error("All models failed.");
        }

        function displayPersona(text) { els.personaContent.innerHTML = marked.parse(text); }
        function setLoading(isLoading, text = '') {
            if(isLoading) {
                els.loading.style.display = 'block';
                els.uploadArea.style.display = 'none';
                els.previewContainer.style.display = 'none';
                els.analyzeBtn.style.display = 'none';
                if(text) els.loadingText.innerText = text;
            } else {
                els.loading.style.display = 'none';
                if(imageBase64) { els.previewContainer.style.display = 'block'; els.analyzeBtn.style.display = 'flex'; }
                else { els.uploadArea.style.display = 'block'; }
            }
        }
        function showToast(msg) { els.toast.innerText = msg; els.toast.classList.add('show'); setTimeout(() => els.toast.classList.remove('show'), 3000); }
        function copyCurrentContent() { navigator.clipboard.writeText(els.activeContent.innerText).then(() => showToast('üìã Copied!')); }
        function copyPersona() { navigator.clipboard.writeText(customPersona).then(() => showToast('üìã Persona copied!')); }

        // ENHANCED PDF EXPORT with IMAGE
        function exportCurrentToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            const maxLineWidth = pageWidth - (margin * 2);
            let cursorY = 20;

            // Header
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text(els.contentTitle.innerText, margin, cursorY);
            cursorY += 10;

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Generated by Synthia on ${new Date().toLocaleDateString()}`, margin, cursorY);
            cursorY += 15;

            // NEW: Add Image to PDF (if not persona tab)
            if(activeTab !== 'persona' && imageBase64 && selectedFile) {
                try {
                    const imgFormat = selectedFile.type.split('/')[1].toUpperCase();
                    const imgData = 'data:' + selectedFile.type + ';base64,' + imageBase64;

                    // Calculate aspect ratio and fit to page width
                    const img = new Image();
                    img.src = imgData;
                    const aspectRatio = img.width / img.height;
                    const imgWidth = maxLineWidth;
                    const imgHeight = imgWidth / aspectRatio;

                    // Check if image fits on current page
                    if(cursorY + imgHeight > pageHeight - 20) {
                        doc.addPage();
                        cursorY = 20;
                    }

                    doc.addImage(imgData, imgFormat === 'JPG' ? 'JPEG' : imgFormat, margin, cursorY, imgWidth, imgHeight);
                    cursorY += imgHeight + 15;
                } catch(err) {
                    console.warn('Image add failed:', err);
                }
            }

            // Content
            doc.setFontSize(11);
            const content = els.activeContent.innerText;
            const splitText = doc.splitTextToSize(content, maxLineWidth);

            splitText.forEach(line => {
                if (cursorY > pageHeight - 20) {
                    doc.addPage();
                    cursorY = 20;
                }
                doc.text(line, margin, cursorY);
                cursorY += 6;
            });

            doc.save(`${activeTab}_content.pdf`);
            showToast('üìÑ Full PDF with image exported!');
        }

        function exportPersonaToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            const maxLineWidth = pageWidth - (margin * 2);

            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text('Brand Persona', margin, 20);

            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");

            const splitText = doc.splitTextToSize(customPersona, maxLineWidth);
            let cursorY = 35;
            const pageHeight = doc.internal.pageSize.getHeight();

            splitText.forEach(line => {
                if (cursorY > pageHeight - 20) {
                    doc.addPage();
                    cursorY = 20;
                }
                doc.text(line, margin, cursorY);
                cursorY += 6;
            });

            doc.save('brand_persona.pdf');
            showToast('üìÑ Persona PDF exported!');
        }
    </script>
</body>
</html>