<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Synthia - AI Marketing Intelligence</title>
    <link rel="icon" type="image/png" href="synthia_icon_transparent.png">

    <!-- Fonts: Inter for premium readability -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Synthia - Responsive Premium Design */

        :root {
            --synthia-primary: #8B5CF6;
            --synthia-secondary: #A78BFA;
            --synthia-accent: #EC4899;
            --synthia-teal: #14B8A6;
            --synthia-gold: #F59E0B;
            --synthia-success: #10B981;

            --glass-thick: rgba(30, 30, 30, 0.6);
            --glass-thin: rgba(60, 60, 60, 0.3);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);

            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.85);
            --text-tertiary: rgba(255, 255, 255, 0.5);

            --radius-xl: 24px;
            --radius-l: 16px;
            --radius-m: 12px;
            --spacing-unit: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-primary);
            background: #000;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .liquid-background {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 15% 50%, rgba(139, 92, 246, 0.4), transparent 40%),
                radial-gradient(circle at 85% 30%, rgba(236, 72, 153, 0.35), transparent 40%),
                radial-gradient(circle at 50% 80%, rgba(167, 139, 250, 0.3), transparent 40%);
            filter: blur(60px);
            animation: liquid-move 20s ease-in-out infinite alternate;
        }

        @keyframes liquid-move {
            0% { transform: scale(1) translate(0, 0); }
            50% { transform: scale(1.1) translate(20px, -20px); }
            100% { transform: scale(1) translate(0, 0); }
        }

        .app-container {
            max-width: 1000px; /* Constrained for better readability on desktop */
            margin: 0 auto;
            padding: 40px 20px 80px;
        }

        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 40px;
            padding: 0 10px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .app-logo {
            width: 64px;
            height: 64px;
            object-fit: contain;
            filter: drop-shadow(0 0 15px rgba(139, 92, 246, 0.5));
            border-radius: 16px;
        }

        h1 {
            font-weight: 800;
            font-size: 3rem;
            letter-spacing: -0.03em;
            background: linear-gradient(135deg, var(--synthia-primary) 0%, var(--synthia-secondary) 50%, var(--synthia-accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            line-height: 1.1;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
            max-width: 680px;
            margin: 0 auto;
            line-height: 1.5;
        }

        /* Responsive Panels */
        .glass-panel {
            background: var(--glass-thick);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--glass-shadow);
            padding: 32px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
        }

        .glass-panel.collapsed {
            max-height: 80px;
            overflow: hidden;
            cursor: pointer;
            padding-bottom: 0;
        }

        .glass-panel.collapsed:hover { background: rgba(40, 40, 40, 0.7); }
        .glass-panel.collapsed #personaInputSection, .glass-panel.collapsed #personaSection { display: none !important; }

        .glass-panel::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.5), transparent);
        }

        .form-group { margin-bottom: 20px; }

        label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .label-with-help { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }

        .help-icon {
            width: 18px; height: 18px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 11px; color: var(--synthia-secondary);
            cursor: pointer;
        }

        input[type="text"], input[type="password"], input[type="url"], textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-m);
            padding: 14px 16px;
            color: white;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s ease;
            -webkit-appearance: none; /* iOS Reset */
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--synthia-primary);
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        textarea { min-height: 120px; resize: vertical; }

        .form-help { font-size: 0.8rem; color: var(--text-tertiary); margin-top: 6px; display: block; }

        /* Buttons - Touch Friendly */
        .btn-primary {
            background: linear-gradient(135deg, var(--synthia-primary), var(--synthia-secondary));
            color: white;
            border: none;
            padding: 16px 24px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--radius-l);
            cursor: pointer;
            width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            min-height: 52px; /* iOS Touch Target */
        }

        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-secondary {
            background: rgba(139, 92, 246, 0.15);
            color: white;
            border: 1px solid rgba(139, 92, 246, 0.3);
            padding: 12px 20px;
            border-radius: var(--radius-m);
            font-weight: 500;
            cursor: pointer;
            min-height: 44px;
            font-size: 0.95rem;
            transition: background 0.2s ease;
        }

        .btn-secondary:hover { background: rgba(139, 92, 246, 0.25); border-color: var(--synthia-primary); }

        .btn-text { background: none; border: none; color: var(--text-tertiary); text-decoration: underline; cursor: pointer; padding: 8px; }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed rgba(139, 92, 246, 0.3);
            border-radius: var(--radius-l);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            background: rgba(139, 92, 246, 0.05);
            transition: border-color 0.2s;
        }
        .upload-zone:active { background: rgba(139, 92, 246, 0.1); border-color: var(--synthia-primary); }
        .upload-icon { font-size: 2.5rem; margin-bottom: 12px; display: block; }

        .preview-container { margin-top: 24px; border-radius: var(--radius-l); overflow: hidden; display: none; position: relative; }
        .preview-image { width: 100%; display: block; }

        /* Tabs - Scrollable on Mobile */
        .segmented-control {
            display: flex;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px;
            border-radius: var(--radius-m);
            margin-bottom: 24px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .segmented-control::-webkit-scrollbar { display: none; }

        .segment-btn {
            flex: 1;
            padding: 10px 16px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            white-space: nowrap;
            min-width: 80px; /* Prevent shrinking too much */
        }

        .segment-btn.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.4), rgba(167, 139, 250, 0.4));
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Content Area */
        .content-area { background: rgba(0, 0, 0, 0.25); border-radius: var(--radius-l); padding: 24px; min-height: 200px; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; gap: 12px; }
        .content-title { font-size: 1.1rem; font-weight: 600; color: white; }

        .content-text { font-size: 1rem; line-height: 1.7; color: rgba(255, 255, 255, 0.9); word-wrap: break-word; }
        .content-text h1, .content-text h2 { color: white; margin: 24px 0 12px; font-weight: 700; line-height: 1.3; }
        .content-text h3 { color: var(--synthia-secondary); margin: 20px 0 10px; font-size: 1.1rem; }
        .content-text p { margin-bottom: 16px; }
        .content-text ul, .content-text ol { margin-bottom: 16px; padding-left: 20px; }
        .content-text li { margin-bottom: 6px; }
        .content-text blockquote { border-left: 3px solid var(--synthia-primary); padding-left: 16px; margin: 16px 0; color: var(--text-tertiary); font-style: italic; }

        /* Loading */
        .loading-overlay { display: none; text-align: center; padding: 40px 20px; }
        .spinner { width: 36px; height: 36px; border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top-color: var(--synthia-primary); animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px);
            padding: 14px 24px; border-radius: 50px; color: white; font-weight: 500; font-size: 0.9rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 3000;
            width: max-content; max-width: 90%; text-align: center; border: 1px solid rgba(255,255,255,0.1);
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px;
        }
        .modal-overlay.show { display: flex; }

        .modal-content {
            background: #1a1a1a; border: 1px solid var(--glass-border);
            border-radius: var(--radius-l); width: 100%; max-width: 600px;
            max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .modal-header { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #1a1a1a; z-index: 10; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: white; }
        .modal-close { background: rgba(255,255,255,0.1); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-body { padding: 24px; }
        .modal-step { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .step-link { display: inline-block; margin-top: 8px; color: var(--synthia-secondary); text-decoration: none; font-weight: 500; font-size: 0.9rem; }

        /* Utilities */
        .flex-row { display: flex; gap: 10px; }
        .collapse-btn { background: none; border: none; color: var(--text-tertiary); font-size: 1.5rem; transform: rotate(0deg); transition: transform 0.3s; padding: 0 10px; cursor: pointer; }
        .glass-panel.collapsed .collapse-btn { transform: rotate(180deg); }
        footer { text-align: center; padding: 40px; color: var(--text-tertiary); font-size: 0.85rem; }

        /* === MOBILE OPTIMIZATIONS === */
        @media (max-width: 640px) {
            .app-container { padding: 20px 16px 60px; }
            h1 { font-size: 2.2rem; }
            .subtitle { font-size: 1rem; padding: 0 10px; }
            .glass-panel { padding: 20px; border-radius: 20px; }
            .app-logo { width: 48px; height: 48px; border-radius: 12px; }

            .content-header { flex-direction: column; align-items: flex-start; gap: 16px; }
            .content-header .flex-row { width: 100%; justify-content: space-between; }
            .btn-secondary { flex: 1; text-align: center; font-size: 0.9rem; padding: 10px; }

            .modal-content { max-height: 90vh; border-radius: 20px; }
            .modal-body { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="liquid-background"></div>

    <div class="app-container">
        <header>
            <div class="logo-container">
                <img src="synthia_icon_transparent.png" alt="Synthia Logo" class="app-logo">
                <h1>Synthia</h1>
            </div>
            <p class="subtitle">Meet Synthia, your AI marketing intelligence platform that synthesizes legendary frameworks with your unique brand voice‚Äîtransforming every image into a complete content ecosystem.</p>
        </header>

        <!-- Configuration -->
        <div class="glass-panel" id="configPanel">
            <div class="content-header" style="flex-direction: row; justify-content: space-between; width: 100%;">
                 <h3 style="margin:0; font-size: 1.1rem; color: white;">Brand Configuration</h3>
                 <div style="display: flex; align-items: center; gap: 8px;">
                    <button id="resetPersonaBtn" class="btn-text" style="display:none; font-size: 0.85rem;">Reset</button>
                    <button class="collapse-btn" id="configCollapseBtn">‚åÑ</button>
                 </div>
            </div>

            <div id="personaInputSection">
                <div class="form-group">
                    <div class="label-with-help">
                        <label>üîë Gemini API Key</label>
                        <span class="help-icon" onclick="showApiKeyHelp()" title="Help">?</span>
                    </div>
                    <input type="password" id="apiKey" placeholder="Paste your AIza... key here">
                    <span class="form-help">Stored locally in your browser. Never sent to our servers.</span>
                </div>

                <div class="form-group">
                    <label>üåê Your Website URL</label>
                    <input type="url" id="websiteUrl" placeholder="https://yourbrand.com">
                </div>

                <div class="form-group">
                    <label>üë• Client Websites (Optional)</label>
                    <textarea id="clientWebsites" placeholder="https://client1.com&#10;https://client2.com" style="min-height: 80px;"></textarea>
                    <span class="form-help">Helps Synthia understand your target audience better.</span>
                </div>

                <button class="btn-primary" id="generatePersonaBtn">
                    <span>üéØ Start Research & Generate Persona</span>
                </button>
            </div>

             <!-- Persona Display -->
            <div id="personaSection" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div class="content-header">
                    <div class="content-title">‚ú® Active Persona</div>
                    <div class="flex-row" style="width: auto;">
                        <button class="btn-secondary" onclick="refinePersona()">Refine</button>
                        <button class="btn-secondary" onclick="exportPersonaToPDF()">PDF</button>
                    </div>
                </div>
                <div class="content-text" id="personaContent" style="max-height: 300px; overflow-y: auto; padding-right: 8px;"></div>
            </div>
        </div>

        <!-- Upload & Analysis -->
        <div class="glass-panel">
            <div class="upload-zone" id="uploadArea">
                <div class="upload-icon">üì∏</div>
                <h3 style="color:white; margin-bottom:8px;">Drop Image Here</h3>
                <p style="color: var(--text-tertiary); font-size: 0.9rem;">or tap to browse library</p>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">

            <div class="preview-container" id="previewContainer">
                <img id="previewImage" class="preview-image">
                <button id="imageRemoveX" style="position:absolute; top:12px; right:12px; width:36px; height:36px; border-radius:50%; background:rgba(0,0,0,0.7); color:white; border:1px solid rgba(255,255,255,0.3); font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; z-index: 10;">√ó</button>
            </div>

            <div class="loading-overlay" id="loading">
                <div class="spinner"></div>
                <p id="loadingText" style="color: var(--text-secondary); font-weight: 500;">Analyzing scene...</p>
                <p id="retryText" style="color: var(--synthia-teal); font-size: 0.85rem; margin-top: 8px; display:none;"></p>
            </div>

            <button class="btn-primary" id="analyzeBtn" style="margin-top: 24px; display: none;">
                <span>üîç Analyze & Generate Content</span>
            </button>

            <button class="btn-secondary" id="resetImageBtn" style="margin-top: 16px; display: none; width: 100%; text-align: center;">
                <span>üîÑ Upload Different Photo</span>
            </button>
        </div>

        <!-- Results -->
        <div class="glass-panel" id="resultsSection" style="display: none;">
            <div class="segmented-control" id="tabs">
                <div class="segment-btn active" data-tab="persona">Persona</div>
                <div class="segment-btn" data-tab="story">Story</div>
                <div class="segment-btn" data-tab="marketing">Copy</div>
                <div class="segment-btn" data-tab="instagram">Social</div>
                <div class="segment-btn" data-tab="blog">Blog</div>
                <div class="segment-btn" data-tab="googleads">Ads</div>
                <div class="segment-btn" data-tab="podcast">Audio</div>
            </div>

            <div class="content-area">
                <div class="content-header">
                    <div class="content-title" id="contentTitle">Persona Used</div>
                    <div class="flex-row">
                        <button class="btn-secondary" onclick="copyCurrentContent()">Copy</button>
                        <button class="btn-secondary" onclick="exportCurrentToPDF()">PDF</button>
                    </div>
                </div>
                <div class="content-text" id="activeContent"></div>
            </div>
        </div>

        <footer>
            Designed & Developed by Vivek Pandit using AI ‚ù§Ô∏è
        </footer>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="apiKeyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üîë API Key Setup</div>
                <button class="modal-close" onclick="closeApiKeyHelp()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--text-secondary); line-height: 1.5;">
                    Synthia requires a free Gemini API key to function.
                </p>
                <div class="modal-step">
                    <strong>1. Get Key</strong><br>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="step-link">Open Google AI Studio ‚Üó</a>
                </div>
                <div class="modal-step">
                    <strong>2. Create</strong><br>
                    <span style="color: var(--text-tertiary);">Click "Create API Key" in the dashboard.</span>
                </div>
                <div class="modal-step" style="border:none;">
                    <strong>3. Paste</strong><br>
                    <span style="color: var(--text-tertiary);">Copy the key (starts with "AIza") and paste it into Synthia.</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="interviewModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üß† Strategy Interview</div>
                <button class="modal-close" onclick="closeInterviewHelp()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 24px; color: var(--text-secondary); font-size: 0.95rem;">
                    Synthia has analyzed your site. Please clarify a few details to ensure accuracy.
                </p>
                <div id="interviewContainer"></div>
                <button class="btn-primary" id="submitInterviewBtn" style="margin-top: 32px;">
                    <span>‚ú® Generate Final Persona</span>
                </button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // ===== LOGIC PRESERVED 100% =====

        let selectedFile = null;
        let imageBase64 = null;
        let customPersona = null;
        let generatedContent = {
            persona: '', story: '', marketing: '', instagram: '', 
            blog: '', googleads: '', podcast: ''
        };
        let activeTab = 'persona';
        let workingModel = null;
        let generatedQuestions = [];
        let isRefining = false; 

        const els = {
            apiKey: document.getElementById('apiKey'),
            websiteUrl: document.getElementById('websiteUrl'),
            clientWebsites: document.getElementById('clientWebsites'),
            generatePersonaBtn: document.getElementById('generatePersonaBtn'),
            configPanel: document.getElementById('configPanel'),
            configCollapseBtn: document.getElementById('configCollapseBtn'),
            personaSection: document.getElementById('personaSection'),
            personaContent: document.getElementById('personaContent'),
            personaInputSection: document.getElementById('personaInputSection'),
            resetPersonaBtn: document.getElementById('resetPersonaBtn'),
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            previewContainer: document.getElementById('previewContainer'),
            previewImage: document.getElementById('previewImage'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            resetImageBtn: document.getElementById('resetImageBtn'),
            imageRemoveX: document.getElementById('imageRemoveX'),
            loading: document.getElementById('loading'),
            loadingText: document.getElementById('loadingText'),
            retryText: document.getElementById('retryText'),
            resultsSection: document.getElementById('resultsSection'),
            activeContent: document.getElementById('activeContent'),
            contentTitle: document.getElementById('contentTitle'),
            toast: document.getElementById('toast'),
            tabs: document.getElementById('tabs'),
            apiKeyModal: document.getElementById('apiKeyModal'),
            interviewModal: document.getElementById('interviewModal'),
            interviewContainer: document.getElementById('interviewContainer'),
            submitInterviewBtn: document.getElementById('submitInterviewBtn')
        };

        function showApiKeyHelp() { els.apiKeyModal.classList.add('show'); document.body.style.overflow = 'hidden'; }
        function closeApiKeyHelp() { els.apiKeyModal.classList.remove('show'); document.body.style.overflow = 'auto'; }
        function closeInterviewHelp() { els.interviewModal.classList.remove('show'); }

        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('geminiApiKey');
            if(savedKey) els.apiKey.value = savedKey;

            const savedPersona = localStorage.getItem('customPersona');
            if(savedPersona) {
                customPersona = savedPersona;
                displayPersona(savedPersona);
                els.personaInputSection.style.display = 'none'; 
                els.personaSection.style.display = 'block'; 
                els.resetPersonaBtn.style.display = 'inline-block';
            }

            els.websiteUrl.value = localStorage.getItem('personaWebsite') || '';
            els.clientWebsites.value = localStorage.getItem('personaClients') || '';
        });

        els.apiKey.addEventListener('blur', (e) => { if(e.target.value.trim()) localStorage.setItem('geminiApiKey', e.target.value.trim()); });
        els.uploadArea.addEventListener('click', () => els.fileInput.click());
        els.uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); els.uploadArea.style.borderColor = 'var(--synthia-primary)'; });
        els.uploadArea.addEventListener('dragleave', () => { els.uploadArea.style.borderColor = 'rgba(139, 92, 246, 0.3)'; });
        els.uploadArea.addEventListener('drop', handleDrop);
        els.fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        els.generatePersonaBtn.addEventListener('click', () => startPersonaResearch(false));
        els.submitInterviewBtn.addEventListener('click', finalizePersonaGeneration);
        els.analyzeBtn.addEventListener('click', analyzeImage);
        els.tabs.addEventListener('click', handleTabClick);
        els.configCollapseBtn.addEventListener('click', () => { els.configPanel.classList.toggle('collapsed'); });

        els.resetImageBtn.addEventListener('click', resetImage);
        els.imageRemoveX.addEventListener('click', resetImage);

        els.resetPersonaBtn.addEventListener('click', () => {
            if(confirm('Reset persona?')) {
                localStorage.removeItem('customPersona');
                customPersona = null;
                els.personaSection.style.display = 'none';
                els.personaInputSection.style.display = 'block';
                els.resetPersonaBtn.style.display = 'none';
                els.configPanel.classList.remove('collapsed');
                showToast('Persona reset.');
            }
        });

        function handleDrop(e) {
            e.preventDefault();
            els.uploadArea.style.borderColor = 'rgba(139, 92, 246, 0.3)';
            if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
        }

        function handleFile(file) {
            if(!file) return;
            if(!file.type.startsWith('image/')) return showToast('Please upload an image file');
            if(file.size > 4 * 1024 * 1024) return showToast('Image must be under 4MB');

            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                els.previewImage.src = e.target.result;
                els.previewContainer.style.display = 'block';
                els.analyzeBtn.style.display = 'flex';
                els.resetImageBtn.style.display = 'block';
                els.uploadArea.style.display = 'none'; 

                imageBase64 = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }

        function resetImage() {
            selectedFile = null;
            imageBase64 = null;
            els.fileInput.value = '';
            els.previewImage.src = '';
            els.previewContainer.style.display = 'none';
            els.analyzeBtn.style.display = 'none';
            els.resetImageBtn.style.display = 'none';
            els.resultsSection.style.display = 'none';
            els.uploadArea.style.display = 'block';
            els.configPanel.classList.remove('collapsed');
            showToast('Image reset.');
        }

        function handleTabClick(e) {
            if(!e.target.classList.contains('segment-btn')) return;
            document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            activeTab = e.target.dataset.tab;

            const titles = { persona: 'Persona Used', story: 'Complete Story', marketing: 'Marketing Copy', instagram: 'Instagram Captions', blog: 'Blog Post', googleads: 'Google Ads', podcast: 'Podcast Script' };
            els.contentTitle.innerText = titles[activeTab];
            els.activeContent.innerHTML = marked.parse(generatedContent[activeTab] || 'Content not available');
        }

        async function startPersonaResearch(refining = false) {
            isRefining = refining;
            const apiKey = els.apiKey.value.trim();
            if(!apiKey) return showToast('Please enter your API key');
            const website = els.websiteUrl.value.trim();
            if(!website) return showToast('Please enter a website URL');

            setLoading(true, refining ? 'Analyzing current persona...' : 'Researching website...');
            els.generatePersonaBtn.disabled = true;

            try {
                const researchPrompt = `You are a world-class brand strategist.
I am providing you with a website URL to analyze: ${website}
${els.clientWebsites.value ? "Also consider these client examples: " + els.clientWebsites.value : ""}
${refining ? "The user wants to REFINE their existing persona. Ask deeper questions." : ""}

Your goal is to build a PERFECT buyer persona.
CRITICAL INSTRUCTIONS:
1. IDENTIFY THE EXACT COMPANY NAME. Do not guess. If the name is not 100% clear from the URL, YOU MUST ASK THE USER FOR THE EXACT NAME.
2. IDENTIFY THE EXACT PRODUCTS/SERVICES. If ambiguous, YOU MUST ASK.

Generate 3-5 specific, high-impact interview questions.
If you are unsure of the Company Name, Question #1 MUST be: "What is the exact official name of your company?"

Return ONLY a raw JSON array of strings. Example: ["What is your company name?", "Who is your ideal customer?"]`;

                const result = await callGeminiAPI(apiKey, researchPrompt, null);

                let questions = [];
                try {
                    const cleanJson = result.replace(/```json|```/g, '').trim();
                    questions = JSON.parse(cleanJson);
                } catch (e) {
                    console.warn("JSON parse failed", e);
                    questions = result.split('\n').filter(q => q.includes('?'));
                }

                if(questions.length === 0) questions = ["What is your EXACT Company Name?", "What specific products do you sell?", "Who is your ideal customer?"];

                els.interviewContainer.innerHTML = '';
                questions.forEach((q, index) => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '20px';
                    div.innerHTML = `<label style="color:var(--synthia-teal); margin-bottom:8px; display:block;">${q}</label><textarea id="answer_${index}" placeholder="Type your answer..." style="min-height:80px;"></textarea>`;
                    els.interviewContainer.appendChild(div);
                });

                generatedQuestions = questions;
                setLoading(false);
                els.interviewModal.classList.add('show');

            } catch(err) {
                showToast('Error: ' + err.message);
                setLoading(false);
                els.generatePersonaBtn.disabled = false;
            }
        }

        function refinePersona() {
            if(confirm('Refine persona with new questions?')) startPersonaResearch(true);
        }

        async function finalizePersonaGeneration() {
            const apiKey = els.apiKey.value.trim();
            const website = els.websiteUrl.value.trim();
            const clients = els.clientWebsites.value.trim();

            let interviewTranscript = "";
            generatedQuestions.forEach((q, index) => {
                const answer = document.getElementById(`answer_${index}`).value.trim();
                if(answer) interviewTranscript += `Q: ${q}\nA: ${answer}\n\n`;
            });

            els.interviewModal.classList.remove('show');
            setLoading(true, 'Synthesizing persona...');

            try {
                const fullPrompt = `You are a world-class marketing strategist.
WEBSITE: ${website}
INTERVIEW: ${interviewTranscript}

Based on this, create a COMPREHENSIVE BUYER PERSONA (1000+ words).
CRITICAL: 
1. ACCURACY IS PARAMOUNT. Use the exact Company Name from the interview answers or website. Do not hallucinate a generic name.
2. Prioritize the user's interview answers over web assumptions.

## 1. COMPANY PROFILE
- Exact Company Name
- Tagline
- Industry & Niche

## 2. BRAND VOICE & PERSONALITY
## 3. TARGET AUDIENCE
## 4. UNIQUE VALUE PROPOSITION
## 5. CONTENT STRATEGY
## 6. COMPETITIVE LANDSCAPE
## 7. MARKETING CHANNELS
## 8. CUSTOMER JOURNEY
## 9. OBJECTIONS & SOLUTIONS
## 10. BRAND GUIDELINES

Use markdown formatting. Be specific.`;

                const personaText = await callGeminiAPI(apiKey, fullPrompt, null);
                customPersona = personaText;
                displayPersona(personaText);

                localStorage.setItem('customPersona', personaText);
                localStorage.setItem('personaWebsite', website);
                localStorage.setItem('personaClients', clients);

                els.personaInputSection.style.display = 'none';
                els.personaSection.style.display = 'block';
                els.resetPersonaBtn.style.display = 'inline-block';
                els.configPanel.classList.add('collapsed');
                showToast('‚úÖ Persona Generated!');

            } catch(err) {
                showToast('Error: ' + err.message);
            } finally {
                setLoading(false);
                els.generatePersonaBtn.disabled = false;
            }
        }

        async function analyzeImage() {
            const apiKey = els.apiKey.value.trim();
            if(!apiKey) return showToast('Please enter API key');
            if(!imageBase64) return showToast('Upload image first');

            els.configPanel.classList.add('collapsed');
            setLoading(true, 'Starting analysis...');
            els.resultsSection.style.display = 'none';
            els.analyzeBtn.disabled = true;
            els.resetImageBtn.style.display = 'none'; 

            try {
                const pContext = customPersona ? 
                    `\n\n=== BRAND PERSONA ===\n${customPersona}\n=== END PERSONA ===\n\nCRITICAL: Use this persona.\n\n` : '';

                const prompts = {
                    story: pContext + `You are Robert McKee, master of story structure, combined with the observational skills of a CSI detective.

Analyze this image and create a COMPELLING NARRATIVE STORY (800-1,200 words) using these frameworks:

1. THREE-ACT STRUCTURE (McKee):
   - Act 1: Setup (Who, What, Where, When - establish context)
   - Act 2: Confrontation (The challenge, conflict, or journey)
   - Act 3: Resolution (The outcome, transformation, or revelation)

2. HERO'S JOURNEY ELEMENTS:
   - Ordinary world ‚Üí Call to adventure ‚Üí Crossing threshold
   - Tests and trials ‚Üí Transformation ‚Üí Return with wisdom

3. CINEMATIC OBSERVATION:
   - Notice EVERY detail (lighting, colors, textures, expressions)
   - Environmental context and atmosphere
   - Emotional undertones and subtext
   - Background elements that tell a story

4. STORYTELLING TECHNIQUES:
   - Use sensory details (what you see, implied sounds/smells)
   - Create character depth (motivations, backstory hints)
   - Build tension and pacing
   - Include dialogue if people are present
   - Use metaphors and vivid language

OUTPUT FORMAT:
- Write in flowing narrative prose
- 800-1,200 words
- Divided into clear beginning, middle, end
- Make it engaging and visual
- Connect details to larger meaning`,

                    marketing: pContext + `You are David Ogilvy, Gary Halbert, and Eugene Schwartz combined - masters of conversion.

Create HIGH-CONVERTING MARKETING COPY using these frameworks:

1. HEADLINES (5 variations using Ogilvy formulas):
   - "How to [Benefit] Even If [Objection]"
   - "The Secret of [Desire]"
   - "[Number] Ways to [Benefit]"
   - "Give Me [Time] and I'll [Promise]"
   - "[Benefit] or Your Money Back"

2. PAS FRAMEWORK (Problem-Agitate-Solution):
   - PROBLEM: What pain does this image represent?
   - AGITATE: Make the problem feel urgent and costly
   - SOLUTION: Present the solution (what's shown) as the answer

3. USP METHOD (Rosser Reeves):
   - Identify 3-5 UNIQUE benefits (not features)
   - Make each benefit specific and ownable
   - Use "So That" chains (feature ‚Üí benefit ‚Üí ultimate benefit)

4. PROOF POINTS:
   - Specificity (exact numbers, details)
   - Social proof elements
   - Risk reversals
   - Guarantees

5. CALL-TO-ACTION:
   - Direct, action-oriented
   - Create urgency
   - Lower friction
   - Promise clear outcome

OUTPUT FORMAT:
- Start with 5 headline variations
- Full body copy (600-800 words)
- Multiple CTAs throughout
- Conversational yet persuasive tone`,

                    instagram: pContext + `You are Gary Vaynerchuk combined with Instagram's top content creators - masters of engagement.

Create 5 VIRAL INSTAGRAM CAPTIONS using these techniques:

1. CAPTION TYPES (Create all 5):
   - STORY CAPTION: Personal story relating to image (150-200 words)
   - QUESTION CAPTION: Thought-provoking question (50-75 words)
   - VALUE CAPTION: Educational tip or insight (100-150 words)
   - BEHIND-THE-SCENES: Reveal process/context (100-150 words)
   - CALL-TO-ACTION: Drive engagement (75-100 words)

2. GARY VEE TECHNIQUES:
   - Start with a hook (first 125 characters count)
   - Use line breaks for readability
   - Include emoji strategically (not excessively)
   - Create pattern interrupts
   - End with clear CTA

3. ENGAGEMENT PSYCHOLOGY:
   - Ask questions (but not generic ones)
   - Create curiosity gaps
   - Use "you" language (talk TO audience)
   - Be authentic and vulnerable
   - Include micro-stories

4. HASHTAG STRATEGY:
   - 3-5 highly relevant hashtags per caption
   - Mix of broad and niche
   - Place at END of caption (not inline)
   - Avoid generic #like4like type tags

OUTPUT FORMAT:
Caption 1 (STORY):
[Caption text with emoji and line breaks]
#hashtag1 #hashtag2 #hashtag3

Caption 2 (QUESTION):
[Caption text]
#hashtags

[Repeat for all 5]`,

                    blog: pContext + `You are Neil Patel and Brian Dean combined - SEO and content marketing masters.

Write an SEO-OPTIMIZED BLOG POST (1,800+ words) using these frameworks:

1. SKYSCRAPER TECHNIQUE (Brian Dean):
   - Make content 10x better than competitors
   - More comprehensive, more visual, more current
   - Answer EVERY related question

2. CONTENT STRUCTURE (Patel method):
   - TITLE: Compelling, keyword-rich, promise-driven (60 chars)
   - META DESCRIPTION: 155-160 chars with CTA
   - INTRO: Hook in first 100 words, preview value
   - H2 SECTIONS: 5-7 main sections
   - H3 SUBSECTIONS: 2-4 per H2
   - CONCLUSION: Summarize + strong CTA

3. SEO OPTIMIZATION:
   - Target primary keyword (identify from image context)
   - LSI keywords naturally integrated
   - Internal linking opportunities mentioned
   - External linking suggestions
   - Image alt text recommendations

4. ENGAGEMENT ELEMENTS:
   - Statistics and data points
   - Examples and case studies
   - Quotes from experts
   - Lists and bullet points
   - Actionable takeaways

5. READABILITY:
   - Flesch Reading Ease: 60-70
   - Sentences: 20 words or fewer
   - Paragraphs: 4-5 lines max
   - Active voice predominant

OUTPUT FORMAT:
Title: [SEO-optimized title]
Meta Description: [155-160 chars]

## Introduction
[Hook and preview - 150 words]

## [H2 Section 1]
### [H3 Subsection]
[Content]

[Continue for 1,800+ words total]

## Conclusion
[Summary and CTA]`,

                    googleads: pContext + `You are Perry Marshall - Google Ads master with 80/20 principle expertise.

Create GOOGLE ADS CAMPAIGN using these frameworks:

1. PERRY MARSHALL'S 80/20:
   - Focus on highest-intent keywords
   - Identify "unicorn" opportunities
   - Quality Score optimization approach

2. AD STRUCTURE (Create 15 headlines + 4 descriptions):
   HEADLINES (30 chars each):
   - Variations 1-5: Benefit-focused
   - Variations 6-10: Problem-focused
   - Variations 11-15: Curiosity/intrigue-focused

   DESCRIPTIONS (90 chars each):
   - Description 1: Expand on benefit + CTA
   - Description 2: Address objection + social proof
   - Description 3: Urgency + guarantee
   - Description 4: Different angle + CTA

3. ADVANCED TACTICS:
   - Countdown customizers suggested
   - Location insertion opportunities
   - Price extension ideas
   - Sitelink suggestions (min 4)
   - Callout extensions (min 4)

4. KEYWORD STRATEGY:
   - 10 high-intent keywords (exact match)
   - 5 phrase match variations
   - 10 negative keywords to exclude
   - Search term themes

5. QUALITY SCORE OPTIMIZATION:
   - Landing page recommendations
   - Ad relevance tips
   - Expected CTR improvements

OUTPUT FORMAT:
HEADLINES (15):
1. [30 chars]
2. [30 chars]
[...]

DESCRIPTIONS (4):
1. [90 chars]
[...]

EXTENSIONS:
[Details]

KEYWORDS:
[Lists]`,

                    podcast: pContext + `You are Joe Rogan, Ira Glass, and Malcolm Gladwell combined - masters of audio storytelling.

Write a PODCAST SCRIPT (12-15 minutes, ~2,000 words) using these techniques:

1. JOE ROGAN'S CONVERSATIONAL STYLE:
   - Natural, authentic delivery
   - Curiosity-driven exploration
   - Personal anecdotes and reflections
   - "What if" speculation
   - Genuine enthusiasm

2. IRA GLASS STRUCTURE (This American Life):
   - COLD OPEN: Start with compelling moment (30-60 sec)
   - SETUP: Context and stakes (2-3 min)
   - EXPLORATION: Deep dive with stories (6-8 min)
   - REFLECTION: What it means (2-3 min)
   - CLOSER: Call-back to opening (1 min)

3. MALCOLM GLADWELL'S STORYTELLING:
   - Start with surprising fact or question
   - Weave multiple perspectives
   - Build to "aha" moment
   - Connect to bigger ideas
   - Leave listeners thinking

4. AUDIO-SPECIFIC TECHNIQUES:
   - Descriptive language (listeners can't see)
   - Vocal variety notes: [pause], [emphasis], [laugh]
   - Sound effect suggestions
   - Music cue recommendations
   - Pacing notes

5. ENGAGEMENT TACTICS:
   - Pose questions to listeners
   - Create cliffhangers before breaks
   - Use callbacks and running jokes
   - Share vulnerable moments
   - End with strong CTA

OUTPUT FORMAT:
[INTRO MUSIC]

HOST:
[Cold open - 30-60 seconds]

[MUSIC TRANSITION]

HOST:
[Setup and context]

[Continue for ~2,000 words with all elements]`
                };

                for (const [key, prompt] of Object.entries(prompts)) {
                    setLoading(true, `Generating ${key}...`);
                    generatedContent[key] = await callGeminiAPI(apiKey, prompt, imageBase64);
                    await new Promise(r => setTimeout(r, 1200)); 
                }

                els.resultsSection.style.display = 'block';
                document.querySelector('[data-tab="story"]').click();
                els.resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                els.resetImageBtn.style.display = 'block';
                showToast('‚úÖ Content generated!');

            } catch(err) {
                showToast('Error: ' + err.message);
                console.error(err);
                els.resetImageBtn.style.display = 'block';
            } finally {
                setLoading(false);
                els.analyzeBtn.disabled = false;
            }
        }

        async function callGeminiAPI(apiKey, prompt, imageBase64 = null) {
            if (workingModel) return executeGeneration(apiKey, workingModel, prompt, imageBase64);
            if (els.retryText) { els.retryText.style.display = 'block'; els.retryText.innerText = 'Discovering models...'; }

            try {
                const listResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if (!listResp.ok) throw new Error('Failed to list models');
                const listData = await listResp.json();

                let candidates = (listData.models || [])
                    .filter(m => m.supportedGenerationMethods?.includes('generateContent'))
                    .sort((a, b) => {
                        const score = n => n.includes('gemini-2.0') ? 100 : n.includes('1.5-pro') ? 90 : n.includes('1.5-flash') ? 80 : 0;
                        return score(b.name) - score(a.name);
                    });

                if (candidates.length === 0) candidates = [{ name: 'models/gemini-2.0-flash' }, { name: 'models/gemini-1.5-flash' }];

                for (const candidate of candidates) {
                    try {
                        const modelName = candidate.name.replace('models/', '');
                        const result = await executeGeneration(apiKey, modelName, prompt, imageBase64);
                        workingModel = modelName;
                        if(els.retryText) els.retryText.style.display = 'none';
                        return result;
                    } catch (e) { }
                }
                throw new Error('No compatible models found.');
            } catch (e) { return fallbackHardcodedGeneration(apiKey, prompt, imageBase64); }
        }

        async function executeGeneration(apiKey, modelName, prompt, imageBase64) {
            if (els.retryText) { els.retryText.style.display = 'block'; els.retryText.innerText = `Generating with ${modelName}...`; }
            const parts = [{ text: prompt }];
            if(imageBase64) parts.push({ inline_data: { mime_type: selectedFile.type, data: imageBase64 } });

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts }],
                    generationConfig: { temperature: 0.9, topK: 40, topP: 0.95, maxOutputTokens: 8192 }
                })
            });

            if(!response.ok) throw new Error((await response.json()).error?.message || 'API Error');
            return (await response.json()).candidates[0].content.parts[0].text;
        }

        async function fallbackHardcodedGeneration(apiKey, prompt, imageBase64) {
             const models = ['gemini-2.0-flash', 'gemini-1.5-flash', 'gemini-1.5-pro'];
             for (const m of models) {
                 try { return await executeGeneration(apiKey, m, prompt, imageBase64); } catch (e) { }
             }
             throw new Error("All models failed.");
        }

        function displayPersona(text) { els.personaContent.innerHTML = marked.parse(text); }
        function setLoading(isLoading, text = '') {
            if(isLoading) {
                els.loading.style.display = 'block';
                els.uploadArea.style.display = 'none';
                els.previewContainer.style.display = 'none';
                els.analyzeBtn.style.display = 'none';
                if(text) els.loadingText.innerText = text;
            } else {
                els.loading.style.display = 'none';
                if(imageBase64) { els.previewContainer.style.display = 'block'; els.analyzeBtn.style.display = 'flex'; }
                else { els.uploadArea.style.display = 'block'; }
            }
        }
        function showToast(msg) { els.toast.innerText = msg; els.toast.classList.add('show'); setTimeout(() => els.toast.classList.remove('show'), 3000); }
        function copyCurrentContent() { navigator.clipboard.writeText(els.activeContent.innerText).then(() => showToast('üìã Copied!')); }
        function copyPersona() { navigator.clipboard.writeText(customPersona).then(() => showToast('üìã Persona copied!')); }
        function exportCurrentToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(els.contentTitle.innerText, 20, 20);
            doc.setFontSize(11);
            doc.text(doc.splitTextToSize(els.activeContent.innerText, 170), 20, 35);
            doc.save(`${activeTab}_content.pdf`);
            showToast('üìÑ exported!');
        }
        function exportPersonaToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Brand Persona', 20, 20);
            doc.setFontSize(11);
            doc.text(doc.splitTextToSize(customPersona, 170), 20, 35);
            doc.save('brand_persona.pdf');
            showToast('üìÑ exported!');
        }
    </script>
</body>
</html>