<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Synthia - AI Marketing Intelligence</title>
    <link rel="icon" type="image/png" href="synthia_icon_transparent.png">

    <!-- Fonts: Inter for premium readability -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Synthia - Responsive Premium Design */

        :root {
            --synthia-primary: #8B5CF6;
            --synthia-secondary: #A78BFA;
            --synthia-accent: #EC4899;
            --synthia-teal: #14B8A6;
            --synthia-gold: #F59E0B;
            --synthia-success: #10B981;

            --glass-thick: rgba(30, 30, 30, 0.6);
            --glass-thin: rgba(60, 60, 60, 0.3);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);

            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.85);
            --text-tertiary: rgba(255, 255, 255, 0.5);

            --radius-xl: 24px;
            --radius-l: 16px;
            --radius-m: 12px;
            --spacing-unit: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-primary);
            background: #000;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .liquid-background {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 15% 50%, rgba(139, 92, 246, 0.4), transparent 40%),
                radial-gradient(circle at 85% 30%, rgba(236, 72, 153, 0.35), transparent 40%),
                radial-gradient(circle at 50% 80%, rgba(167, 139, 250, 0.3), transparent 40%);
            filter: blur(60px);
            animation: liquid-move 20s ease-in-out infinite alternate;
        }

        @keyframes liquid-move {
            0% { transform: scale(1) translate(0, 0); }
            50% { transform: scale(1.1) translate(20px, -20px); }
            100% { transform: scale(1) translate(0, 0); }
        }

        .app-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 20px 80px;
        }

        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 40px;
            padding: 0 10px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .app-logo {
            width: 64px;
            height: 64px;
            object-fit: contain;
            filter: drop-shadow(0 0 15px rgba(139, 92, 246, 0.5));
            border-radius: 16px;
        }

        h1 {
            font-weight: 800;
            font-size: 3rem;
            letter-spacing: -0.03em;
            background: linear-gradient(135deg, var(--synthia-primary) 0%, var(--synthia-secondary) 50%, var(--synthia-accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            line-height: 1.1;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
            max-width: 680px;
            margin: 0 auto;
            line-height: 1.5;
        }

        .glass-panel {
            background: var(--glass-thick);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--glass-shadow);
            padding: 32px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
        }

        .glass-panel.collapsed {
            max-height: 80px;
            overflow: hidden;
            cursor: pointer;
            padding-bottom: 0;
        }

        .glass-panel.collapsed:hover { background: rgba(40, 40, 40, 0.7); }
        .glass-panel.collapsed #personaInputSection, .glass-panel.collapsed #personaSection { display: none !important; }

        .glass-panel::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.5), transparent);
        }

        .form-group { margin-bottom: 20px; }

        label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .label-with-help { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }

        .help-icon {
            width: 18px; height: 18px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 11px; color: var(--synthia-secondary);
            cursor: pointer;
        }

        input[type="text"], input[type="password"], input[type="url"], textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-m);
            padding: 14px 16px;
            color: white;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s ease;
            -webkit-appearance: none;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--synthia-primary);
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        textarea { min-height: 120px; resize: vertical; }

        .form-help { font-size: 0.8rem; color: var(--text-tertiary); margin-top: 6px; display: block; }

        .btn-primary {
            background: linear-gradient(135deg, var(--synthia-primary), var(--synthia-secondary));
            color: white;
            border: none;
            padding: 16px 24px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--radius-l);
            cursor: pointer;
            width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            min-height: 52px;
        }

        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-secondary {
            background: rgba(139, 92, 246, 0.15);
            color: white;
            border: 1px solid rgba(139, 92, 246, 0.3);
            padding: 12px 20px;
            border-radius: var(--radius-m);
            font-weight: 500;
            cursor: pointer;
            min-height: 44px;
            font-size: 0.95rem;
            transition: background 0.2s ease;
        }

        .btn-secondary:hover { background: rgba(139, 92, 246, 0.25); border-color: var(--synthia-primary); }

        .btn-text { background: none; border: none; color: var(--text-tertiary); text-decoration: underline; cursor: pointer; padding: 8px; }

        .upload-zone {
            border: 2px dashed rgba(139, 92, 246, 0.3);
            border-radius: var(--radius-l);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            background: rgba(139, 92, 246, 0.05);
            transition: border-color 0.2s;
        }
        .upload-zone:active { background: rgba(139, 92, 246, 0.1); border-color: var(--synthia-primary); }
        .upload-icon { font-size: 2.5rem; margin-bottom: 12px; display: block; }

        .preview-container { margin-top: 24px; border-radius: var(--radius-l); overflow: hidden; display: none; position: relative; }
        .preview-image { width: 100%; display: block; }

        .segmented-control {
            display: flex;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px;
            border-radius: var(--radius-m);
            margin-bottom: 24px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .segmented-control::-webkit-scrollbar { display: none; }

        .segment-btn {
            flex: 1;
            padding: 10px 14px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            white-space: nowrap;
            min-width: 75px;
        }

        .segment-btn.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.4), rgba(167, 139, 250, 0.4));
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .content-area { background: rgba(0, 0, 0, 0.25); border-radius: var(--radius-l); padding: 24px; min-height: 200px; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; gap: 12px; }
        .content-title { font-size: 1.1rem; font-weight: 600; color: white; }

        .content-image-wrapper {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 24px;
            border-radius: var(--radius-l);
            overflow: hidden;
            border: 1px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        .content-image {
            width: 100%;
            display: block;
        }

        .content-text { font-size: 1rem; line-height: 1.7; color: rgba(255, 255, 255, 0.9); word-wrap: break-word; }
        .content-text h1, .content-text h2 { color: white; margin: 24px 0 12px; font-weight: 700; line-height: 1.3; }
        .content-text h3 { color: var(--synthia-secondary); margin: 20px 0 10px; font-size: 1.1rem; }
        .content-text p { margin-bottom: 16px; }
        .content-text ul, .content-text ol { margin-bottom: 16px; padding-left: 20px; }
        .content-text li { margin-bottom: 6px; }
        .content-text blockquote { border-left: 3px solid var(--synthia-primary); padding-left: 16px; margin: 16px 0; color: var(--text-tertiary); font-style: italic; }

        /* Calendar specific styles */
        .content-text table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .content-text th { text-align: left; border-bottom: 2px solid var(--synthia-secondary); padding: 10px; color: var(--synthia-secondary); }
        .content-text td { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 10px; vertical-align: top; }
        .content-text tr:hover { background: rgba(139, 92, 246, 0.1); }

        /* TRACKER DASHBOARD */
        .tracker-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-m);
            padding: 20px;
            text-align: center;
        }

        .stat-value { font-size: 2rem; font-weight: 700; color: var(--synthia-secondary); margin-bottom: 5px; }
        .stat-label { font-size: 0.85rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }

        .progress-bar-container { background: rgba(0, 0, 0, 0.3); border-radius: 20px; height: 12px; width: 100%; margin-top: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--synthia-primary), var(--synthia-success)); width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* VIEW TOGGLE */
        .view-toggle {
            background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px; padding: 4px; display: inline-flex; gap: 4px;
        }
        .view-btn {
            background: transparent; border: none; color: var(--text-tertiary); padding: 8px 16px;
            border-radius: 24px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .view-btn.active { background: var(--synthia-secondary); color: black; box-shadow: 0 4px 12px rgba(167, 139, 250, 0.3); }

        /* LIST VIEW */
        .task-list { display: flex; flex-direction: column; gap: 12px; }
        .task-item {
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-m); padding: 16px; display: flex; align-items: flex-start; gap: 16px; transition: all 0.2s ease;
        }
        .task-item:hover { background: rgba(255, 255, 255, 0.06); border-color: rgba(255, 255, 255, 0.1); }
        .task-item.completed { border-color: var(--synthia-success); background: rgba(16, 185, 129, 0.05); }
        .task-item.completed .task-title { text-decoration: line-through; color: var(--text-tertiary); }
        .task-checkbox {
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--text-tertiary);
            background: transparent; cursor: pointer; margin-top: 2px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0;
        }
        .task-item.completed .task-checkbox { background: var(--synthia-success); border-color: var(--synthia-success); color: white; }
        .task-item.completed .task-checkbox::after { content: '‚úì'; font-size: 14px; font-weight: bold; }
        .task-content { flex: 1; }
        .task-meta { display: flex; gap: 10px; margin-bottom: 4px; font-size: 0.75rem; color: var(--synthia-secondary); font-weight: 600; text-transform: uppercase; }
        .task-title { font-size: 1rem; color: var(--text-primary); margin-bottom: 4px; }
        .task-notes { 
            width: 100%; background: rgba(0,0,0,0.2); border: 1px solid transparent; 
            color: var(--text-secondary); font-size: 0.9rem; padding: 8px; border-radius: 8px; margin-top: 8px; resize: none; min-height: 40px;
        }
        .task-notes:focus { border-color: var(--synthia-primary); outline: none; background: rgba(0,0,0,0.4); }

        /* KANBAN BOARD (NEW v3.4) */
        .kanban-board {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px; align-items: start; margin-top: 20px; overflow-x: auto; padding-bottom: 20px;
        }
        .kanban-column {
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-l); padding: 16px; min-height: 400px; display: flex; flex-direction: column; gap: 12px;
        }
        .kanban-column-header {
            font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--text-secondary); padding-bottom: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 8px; display: flex; justify-content: space-between;
        }
        .kanban-count { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }

        .kanban-card {
            background: rgba(40, 40, 40, 0.6); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--radius-m);
            padding: 14px; cursor: grab; transition: transform 0.2s, box-shadow 0.2s; position: relative;
        }
        .kanban-card:active { cursor: grabbing; transform: scale(1.02); }
        .kanban-card:hover { border-color: var(--synthia-secondary); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .kanban-card.dragging { opacity: 0.5; border: 1px dashed var(--synthia-primary); }

        .kanban-column.drag-over { background: rgba(139, 92, 246, 0.1); border-color: var(--synthia-primary); }

        .loading-overlay { display: none; text-align: center; padding: 40px 20px; }
        .spinner { width: 36px; height: 36px; border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top-color: var(--synthia-primary); animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px);
            padding: 14px 24px; border-radius: 50px; color: white; font-weight: 500; font-size: 0.9rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 3000;
            width: max-content; max-width: 90%; text-align: center; border: 1px solid rgba(255,255,255,0.1);
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px;
        }
        .modal-overlay.show { display: flex; }

        .modal-content {
            background: #1a1a1a; border: 1px solid var(--glass-border);
            border-radius: var(--radius-l); width: 100%; max-width: 600px;
            max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .modal-header { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #1a1a1a; z-index: 10; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: white; }
        .modal-close { background: rgba(255,255,255,0.1); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-body { padding: 24px; }
        .modal-step { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .step-link { display: inline-block; margin-top: 8px; color: var(--synthia-secondary); text-decoration: none; font-weight: 500; font-size: 0.9rem; }

        .flex-row { display: flex; gap: 10px; }
        .collapse-btn { background: none; border: none; color: var(--text-tertiary); font-size: 1.5rem; transform: rotate(0deg); transition: transform 0.3s; padding: 0 10px; cursor: pointer; }
        .glass-panel.collapsed .collapse-btn { transform: rotate(180deg); }
        footer { text-align: center; padding: 40px; color: var(--text-tertiary); font-size: 0.85rem; }

        @media (max-width: 640px) {
            .app-container { padding: 20px 16px 60px; }
            h1 { font-size: 2.2rem; }
            .subtitle { font-size: 1rem; padding: 0 10px; }
            .glass-panel { padding: 20px; border-radius: 20px; }
            .app-logo { width: 48px; height: 48px; border-radius: 12px; }

            .content-header { flex-direction: column; align-items: flex-start; gap: 16px; }
            .content-header .flex-row { width: 100%; justify-content: space-between; }
            .btn-secondary { flex: 1; text-align: center; font-size: 0.9rem; padding: 10px; }

            .modal-content { max-height: 90vh; border-radius: 20px; }
            .modal-body { padding: 20px; }
            .segment-btn { font-size: 0.8rem; padding: 8px 10px; min-width: 65px; }

            .kanban-board {
                display: flex; flex-direction: row; overflow-x: auto; scroll-snap-type: x mandatory; gap: 16px; padding-bottom: 20px;
            }
            .kanban-column { min-width: 85vw; scroll-snap-align: center; }
        }
    </style>
</head>
<body>
    <div class="liquid-background"></div>

    <div class="app-container">
        <header>
            <div class="logo-container">
                <img src="synthia_icon_transparent.png" alt="Synthia Logo" class="app-logo">
                <h1>Synthia</h1>
            </div>
            <p class="subtitle">Meet Synthia, your AI marketing intelligence platform that synthesizes legendary frameworks with your unique brand voice‚Äîtransforming every image into a complete content ecosystem.</p>
        </header>

        <div class="glass-panel" id="configPanel">
            <div class="content-header" style="flex-direction: row; justify-content: space-between; width: 100%;">
                 <h3 style="margin:0; font-size: 1.1rem; color: white;">Brand Configuration</h3>
                 <div style="display: flex; align-items: center; gap: 8px;">
                    <button id="resetPersonaBtn" class="btn-text" style="display:none; font-size: 0.85rem;">Reset</button>
                    <button class="collapse-btn" id="configCollapseBtn">‚åÑ</button>
                 </div>
            </div>

            <div id="personaInputSection">
                <div class="form-group">
                    <div class="label-with-help">
                        <label>üîë Gemini API Key</label>
                        <span class="help-icon" onclick="showApiKeyHelp()" title="Help">?</span>
                    </div>
                    <input type="password" id="apiKey" placeholder="Paste your AIza... key here">
                    <span class="form-help">Stored locally in your browser. Never sent to our servers.</span>
                </div>

                <div class="form-group">
                    <label>üåê Your Website URL</label>
                    <input type="url" id="websiteUrl" placeholder="https://yourbrand.com">
                </div>

                <div class="form-group">
                    <label>üë• Client Websites (Optional)</label>
                    <textarea id="clientWebsites" placeholder="https://client1.com&#10;https://client2.com" style="min-height: 80px;"></textarea>
                    <span class="form-help">Helps Synthia understand your target audience better.</span>
                </div>

                <button class="btn-primary" id="generatePersonaBtn">
                    <span>üéØ Start Research & Generate Persona</span>
                </button>
            </div>

            <div id="personaSection" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div class="content-header">
                    <div class="content-title">‚ú® Active Persona</div>
                    <div class="flex-row" style="width: auto;">
                        <button class="btn-secondary" onclick="refinePersona()">Refine</button>
                        <button class="btn-secondary" onclick="exportPersonaToPDF()">PDF</button>
                    </div>
                </div>
                <div class="content-text" id="personaContent" style="max-height: 300px; overflow-y: auto; padding-right: 8px;"></div>
            </div>
        </div>

        <div class="glass-panel">
            <div class="upload-zone" id="uploadArea">
                <div class="upload-icon">üì∏</div>
                <h3 style="color:white; margin-bottom:8px;">Drop Image Here</h3>
                <p style="color: var(--text-tertiary); font-size: 0.9rem;">or tap to browse library</p>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">

            <div class="preview-container" id="previewContainer">
                <img id="previewImage" class="preview-image">
                <button id="imageRemoveX" style="position:absolute; top:12px; right:12px; width:36px; height:36px; border-radius:50%; background:rgba(0,0,0,0.7); color:white; border:1px solid rgba(255,255,255,0.3); font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; z-index: 10;">√ó</button>
            </div>

            <div class="loading-overlay" id="loading">
                <div class="spinner"></div>
                <p id="loadingText" style="color: var(--text-secondary); font-weight: 500;">Analyzing scene...</p>
                <p id="retryText" style="color: var(--synthia-teal); font-size: 0.85rem; margin-top: 8px; display:none;"></p>
            </div>

            <button class="btn-primary" id="analyzeBtn" style="margin-top: 24px; display: none;">
                <span>üîç Analyze & Generate Content</span>
            </button>

            <button class="btn-secondary" id="resetImageBtn" style="margin-top: 16px; display: none; width: 100%; text-align: center;">
                <span>üîÑ Upload Different Photo</span>
            </button>
        </div>

        <div class="glass-panel" id="resultsSection" style="display: none;">
            <div class="segmented-control" id="tabs">
                <div class="segment-btn active" data-tab="persona">Persona</div>
                <div class="segment-btn" data-tab="calendar">Calendar</div>
                <div class="segment-btn" data-tab="tracker">Tracker</div>
                <div class="segment-btn" data-tab="story">Story</div>
                <div class="segment-btn" data-tab="marketing">Copy</div>
                <div class="segment-btn" data-tab="instagram">Social</div>
                <div class="segment-btn" data-tab="blog">Blog</div>
                <div class="segment-btn" data-tab="googleads">Ads</div>
                <div class="segment-btn" data-tab="podcast">Audio</div>
                <div class="segment-btn" data-tab="aeo">AEO</div>
            </div>

            <div class="content-area">
                <div class="content-header">
                    <div class="content-title" id="contentTitle">Persona Used</div>
                    <!-- Tracker View Toggle -->
                    <div id="trackerViewToggle" style="display:none;" class="view-toggle">
                        <button class="view-btn active" onclick="setTrackerView('list')">List</button>
                        <button class="view-btn" onclick="setTrackerView('board')">Kanban</button>
                    </div>
                    <div class="flex-row">
                        <button class="btn-secondary" id="resetTrackerBtn" style="display:none;" onclick="resetTracker()">Reset Tracker</button>
                        <button class="btn-secondary" onclick="copyCurrentContent()">Copy</button>
                        <button class="btn-secondary" onclick="exportCurrentToPDF()">PDF</button>
                    </div>
                </div>

                <div id="contentImageContainer" style="display:none;"></div>

                <div class="content-text" id="activeContent"></div>
            </div>
        </div>

        <footer>
            Designed & Developed by Vivek Pandit using AI ‚ù§Ô∏è
        </footer>
    </div>

    <!-- Modals and Toast -->
    <div class="modal-overlay" id="apiKeyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üîë API Key Setup</div>
                <button class="modal-close" onclick="closeApiKeyHelp()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--text-secondary); line-height: 1.5;">Synthia requires a free Gemini API key.</p>
                <div class="modal-step"><strong>1. Get Key</strong><br><a href="https://aistudio.google.com/app/apikey" target="_blank" class="step-link">Open Google AI Studio ‚Üó</a></div>
                <div class="modal-step"><strong>2. Create</strong><br><span style="color: var(--text-tertiary);">Click "Create API Key".</span></div>
                <div class="modal-step" style="border:none;"><strong>3. Paste</strong><br><span style="color: var(--text-tertiary);">Paste key here.</span></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="interviewModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üß† Strategy Interview</div>
                <button class="modal-close" onclick="closeInterviewHelp()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 24px; color: var(--text-secondary); font-size: 0.95rem;">Please clarify a few details.</p>
                <div id="interviewContainer"></div>
                <button class="btn-primary" id="submitInterviewBtn" style="margin-top: 32px;"><span>‚ú® Generate Final Persona</span></button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        let selectedFile = null;
        let imageBase64 = null;
        let customPersona = null;
        let generatedContent = {
            persona: '', calendar: '', tracker: '', story: '', marketing: '', instagram: '', 
            blog: '', googleads: '', podcast: '', aeo: ''
        };
        let campaignTasks = []; 
        let activeTab = 'persona';
        let trackerMode = 'list'; // 'list' or 'board'
        let workingModel = null;
        let generatedQuestions = [];
        let isRefining = false; 

        const els = {
            apiKey: document.getElementById('apiKey'),
            websiteUrl: document.getElementById('websiteUrl'),
            clientWebsites: document.getElementById('clientWebsites'),
            generatePersonaBtn: document.getElementById('generatePersonaBtn'),
            configPanel: document.getElementById('configPanel'),
            configCollapseBtn: document.getElementById('configCollapseBtn'),
            personaSection: document.getElementById('personaSection'),
            personaContent: document.getElementById('personaContent'),
            personaInputSection: document.getElementById('personaInputSection'),
            resetPersonaBtn: document.getElementById('resetPersonaBtn'),
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            previewContainer: document.getElementById('previewContainer'),
            previewImage: document.getElementById('previewImage'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            resetImageBtn: document.getElementById('resetImageBtn'),
            imageRemoveX: document.getElementById('imageRemoveX'),
            loading: document.getElementById('loading'),
            loadingText: document.getElementById('loadingText'),
            retryText: document.getElementById('retryText'),
            resultsSection: document.getElementById('resultsSection'),
            activeContent: document.getElementById('activeContent'),
            contentTitle: document.getElementById('contentTitle'),
            toast: document.getElementById('toast'),
            tabs: document.getElementById('tabs'),
            apiKeyModal: document.getElementById('apiKeyModal'),
            interviewModal: document.getElementById('interviewModal'),
            interviewContainer: document.getElementById('interviewContainer'),
            submitInterviewBtn: document.getElementById('submitInterviewBtn'),
            contentImageContainer: document.getElementById('contentImageContainer'),
            resetTrackerBtn: document.getElementById('resetTrackerBtn'),
            trackerViewToggle: document.getElementById('trackerViewToggle')
        };

        function showApiKeyHelp() { els.apiKeyModal.classList.add('show'); document.body.style.overflow = 'hidden'; }
        function closeApiKeyHelp() { els.apiKeyModal.classList.remove('show'); document.body.style.overflow = 'auto'; }
        function closeInterviewHelp() { els.interviewModal.classList.remove('show'); }

        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('geminiApiKey');
            if(savedKey) els.apiKey.value = savedKey;

            const savedPersona = localStorage.getItem('customPersona');
            if(savedPersona) {
                customPersona = savedPersona;
                displayPersona(savedPersona);
                els.personaInputSection.style.display = 'none'; 
                els.personaSection.style.display = 'block'; 
                els.resetPersonaBtn.style.display = 'inline-block';
            }

            els.websiteUrl.value = localStorage.getItem('personaWebsite') || '';
            els.clientWebsites.value = localStorage.getItem('personaClients') || '';

            // Load saved tracker state with Migration Logic
            const savedTasks = localStorage.getItem('synthiaTrackerTasks');
            if (savedTasks) {
                let tasks = JSON.parse(savedTasks);
                // V3.4 MIGRATION: Ensure 'status' field exists
                campaignTasks = tasks.map(t => ({
                    ...t,
                    status: t.status || (t.completed ? 'done' : 'todo')
                }));
            }
        });

        // Basic event listeners
        els.apiKey.addEventListener('blur', (e) => { if(e.target.value.trim()) localStorage.setItem('geminiApiKey', e.target.value.trim()); });
        els.uploadArea.addEventListener('click', () => els.fileInput.click());
        els.uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); els.uploadArea.style.borderColor = 'var(--synthia-primary)'; });
        els.uploadArea.addEventListener('dragleave', () => { els.uploadArea.style.borderColor = 'rgba(139, 92, 246, 0.3)'; });
        els.uploadArea.addEventListener('drop', handleDrop);
        els.fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        els.generatePersonaBtn.addEventListener('click', () => startPersonaResearch(false));
        els.submitInterviewBtn.addEventListener('click', finalizePersonaGeneration);
        els.analyzeBtn.addEventListener('click', analyzeImage);
        els.tabs.addEventListener('click', handleTabClick);
        els.configCollapseBtn.addEventListener('click', () => { els.configPanel.classList.toggle('collapsed'); });
        els.resetImageBtn.addEventListener('click', resetImage);
        els.imageRemoveX.addEventListener('click', resetImage);
        els.resetPersonaBtn.addEventListener('click', () => {
            if(confirm('Reset persona?')) {
                localStorage.removeItem('customPersona');
                customPersona = null;
                els.personaSection.style.display = 'none';
                els.personaInputSection.style.display = 'block';
                els.resetPersonaBtn.style.display = 'none';
                els.configPanel.classList.remove('collapsed');
                showToast('Persona reset.');
            }
        });

        function handleDrop(e) { e.preventDefault(); els.uploadArea.style.borderColor = 'rgba(139, 92, 246, 0.3)'; if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); }
        function handleFile(file) {
            if(!file || !file.type.startsWith('image/') || file.size > 4*1024*1024) return showToast('Please upload an image file under 4MB');
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                els.previewImage.src = e.target.result;
                els.previewContainer.style.display = 'block';
                els.analyzeBtn.style.display = 'flex';
                els.resetImageBtn.style.display = 'block';
                els.uploadArea.style.display = 'none'; 
                imageBase64 = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }
        function resetImage() {
            selectedFile = null; imageBase64 = null; els.fileInput.value = '';
            els.previewImage.src = ''; els.previewContainer.style.display = 'none';
            els.analyzeBtn.style.display = 'none'; els.resetImageBtn.style.display = 'none';
            els.resultsSection.style.display = 'none'; els.uploadArea.style.display = 'block';
            els.configPanel.classList.remove('collapsed'); showToast('Image reset.');
        }

        function handleTabClick(e) {
            if(!e.target.classList.contains('segment-btn')) return;
            document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            activeTab = e.target.dataset.tab;

            const titles = { 
                persona: 'Persona Used', calendar: 'Marketing Calendar', tracker: 'Campaign Command Center',
                story: 'Complete Story', marketing: 'Marketing Copy', instagram: 'Instagram Captions', 
                blog: 'Blog Post', googleads: 'Google Ads', podcast: 'Podcast Script', aeo: 'AEO Website Audit'
            };
            els.contentTitle.innerText = titles[activeTab];

            if (activeTab === 'tracker') {
                els.resetTrackerBtn.style.display = 'inline-block';
                els.trackerViewToggle.style.display = 'inline-flex';
                renderTrackerUI();
            } else {
                els.activeContent.innerHTML = marked.parse(generatedContent[activeTab] || 'Content not available');
                els.resetTrackerBtn.style.display = 'none';
                els.trackerViewToggle.style.display = 'none';
            }

            if(activeTab !== 'persona' && activeTab !== 'tracker' && imageBase64) {
                els.contentImageContainer.style.display = 'block';
                els.contentImageContainer.innerHTML = '<div class="content-image-wrapper"><img src="data:image/' + selectedFile.type.split('/')[1] + ';base64,' + imageBase64 + '" class="content-image" alt="Analyzed Image"></div>';
            } else { els.contentImageContainer.style.display = 'none'; }
        }

        // --- TRACKER & KANBAN LOGIC ---

        window.setTrackerView = function(mode) {
            trackerMode = mode;
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.view-btn[onclick="setTrackerView('${mode}')"]`).classList.add('active');
            renderTrackerUI();
        }

        function parseMarkdownTable(markdown) {
            const lines = markdown.split('\n');
            const tasks = [];
            let headerFound = false;
            for (const line of lines) {
                if (line.trim().startsWith('|')) {
                    if (!headerFound) {
                        if (line.includes('---')) headerFound = true; 
                        continue; 
                    }
                    const cols = line.split('|').map(c => c.trim()).filter(c => c);
                    if (cols.length >= 4) {
                        tasks.push({
                            id: Date.now() + Math.random(),
                            day: cols[0], channel: cols[1], type: cols[2], topic: cols[3], goal: cols[4] || '',
                            completed: false, status: 'todo', notes: ''
                        });
                    }
                }
            }
            return tasks;
        }

        function renderTrackerUI() {
            if (!campaignTasks || campaignTasks.length === 0) {
                els.activeContent.innerHTML = '<p style="text-align:center; padding:40px; color:var(--text-tertiary);">No active campaign. Generate a Marketing Calendar first to initialize the tracker.</p>';
                return;
            }

            const total = campaignTasks.length;
            const completed = campaignTasks.filter(t => t.status === 'done').length;
            const progress = total === 0 ? 0 : Math.round((completed / total) * 100);

            // Dashboard Header
            let html = `
                <div class="tracker-dashboard">
                    <div class="stat-card"><div class="stat-value">${progress}%</div><div class="stat-label">Completion</div><div class="progress-bar-container"><div class="progress-bar-fill" style="width: ${progress}%"></div></div></div>
                    <div class="stat-card"><div class="stat-value">${completed}/${total}</div><div class="stat-label">Tasks Done</div></div>
                    <div class="stat-card"><div class="stat-value">${total - completed}</div><div class="stat-label">Remaining</div></div>
                </div>
            `;

            if (trackerMode === 'list') {
                html += `<div class="task-list">`;
                campaignTasks.forEach((task, index) => {
                    const isDone = task.status === 'done';
                    html += `
                        <div class="task-item ${isDone ? 'completed' : ''}" id="task-${task.id}">
                            <div class="task-checkbox" onclick="toggleTask(${index})"></div>
                            <div class="task-content">
                                <div class="task-meta">${task.day} ‚Ä¢ ${task.channel} ‚Ä¢ ${task.type}</div>
                                <div class="task-title">${task.topic}</div>
                                <textarea class="task-notes" placeholder="Add notes here..." onchange="updateTaskNote(${index}, this.value)">${task.notes || ''}</textarea>
                            </div>
                        </div>`;
                });
                html += `</div>`;
            } else {
                // KANBAN VIEW
                const cols = { todo: [], doing: [], done: [] };
                campaignTasks.forEach((task, index) => {
                    cols[task.status].push({ ...task, index }); // store original index
                });

                html += `<div class="kanban-board">`;
                ['todo', 'doing', 'done'].forEach(status => {
                    const label = status === 'todo' ? 'To Do' : status === 'doing' ? 'In Progress' : 'Done';
                    html += `
                        <div class="kanban-column" ondragover="allowDrop(event)" ondrop="drop(event, '${status}')">
                            <div class="kanban-column-header"><span>${label}</span><span class="kanban-count">${cols[status].length}</span></div>
                            <div class="kanban-items">`;

                    cols[status].forEach(item => {
                        html += `
                            <div class="kanban-card" draggable="true" ondragstart="drag(event, ${item.index})">
                                <div style="font-size:0.7rem; color:var(--synthia-secondary); margin-bottom:4px;">${item.day} ‚Ä¢ ${item.channel}</div>
                                <div style="font-size:0.9rem; margin-bottom:8px;">${item.topic}</div>
                                <div style="font-size:0.75rem; color:var(--text-tertiary);">${item.notes ? 'üìù Has notes' : ''}</div>
                            </div>`;
                    });
                    html += `</div></div>`;
                });
                html += `</div>`;
            }
            els.activeContent.innerHTML = html;
        }

        window.toggleTask = function(index) {
            const task = campaignTasks[index];
            task.status = task.status === 'done' ? 'todo' : 'done';
            task.completed = task.status === 'done'; // sync legacy
            saveTrackerState();
            renderTrackerUI();
        };

        window.updateTaskNote = function(index, value) {
            campaignTasks[index].notes = value;
            saveTrackerState();
        };

        // Drag & Drop Functions
        window.allowDrop = function(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); };
        window.drag = function(ev, index) { 
            ev.dataTransfer.setData("text", index); 
            ev.target.classList.add('dragging');
        };
        window.drop = function(ev, newStatus) {
            ev.preventDefault();
            document.querySelectorAll('.kanban-column').forEach(c => c.classList.remove('drag-over'));
            const index = ev.dataTransfer.getData("text");
            if (index) {
                const task = campaignTasks[index];
                if (task.status !== newStatus) {
                    task.status = newStatus;
                    task.completed = newStatus === 'done';
                    saveTrackerState();
                    renderTrackerUI();
                }
            }
        };

        // Remove drag styling on dragend if dropped outside
        document.addEventListener("dragend", (event) => { event.target.classList.remove("dragging"); });
        document.addEventListener("dragleave", (event) => { 
            if(event.target.classList.contains('kanban-column')) event.target.classList.remove("drag-over"); 
        });

        function saveTrackerState() { localStorage.setItem('synthiaTrackerTasks', JSON.stringify(campaignTasks)); }
        function resetTracker() {
            if(confirm("Are you sure you want to reset all progress?")) {
                campaignTasks.forEach(t => { t.status = 'todo'; t.completed = false; t.notes = ''; });
                saveTrackerState();
                renderTrackerUI();
                showToast('Tracker reset.');
            }
        }

        // --- END TRACKER LOGIC ---

        async function startPersonaResearch(refining = false) {
            isRefining = refining;
            const apiKey = els.apiKey.value.trim();
            if(!apiKey) return showToast('Please enter your API key');
            setLoading(true, refining ? 'Analyzing...' : 'Researching...');
            els.generatePersonaBtn.disabled = true;

            try {
                const researchPrompt = `You are a brand strategist. Analyze: ${els.websiteUrl.value}
${els.clientWebsites.value ? "Clients: " + els.clientWebsites.value : ""}
Return JSON array of 3 questions to build a persona. Must ask: "Product or Service?" and "Client or Own Company?".`;

                const result = await callGeminiAPI(apiKey, researchPrompt, null);
                let questions = [];
                try { questions = JSON.parse(result.replace(/```json|```/g, '').trim()); } 
                catch (e) { questions = ["Is this a Product or Service?", "Are you the owner?"]; }

                els.interviewContainer.innerHTML = '';
                questions.forEach((q, index) => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '20px';
                    div.innerHTML = `<label style="color:var(--synthia-teal); margin-bottom:8px; display:block;">${q}</label><textarea id="answer_${index}" placeholder="Type your answer..." style="min-height:80px;"></textarea>`;
                    els.interviewContainer.appendChild(div);
                });
                generatedQuestions = questions;
                setLoading(false); els.interviewModal.classList.add('show');
            } catch(err) { showToast('Error: ' + err.message); setLoading(false); els.generatePersonaBtn.disabled = false; }
        }

        function refinePersona() { if(confirm('Refine persona?')) startPersonaResearch(true); }

        async function finalizePersonaGeneration() {
            const apiKey = els.apiKey.value.trim();
            let interviewTranscript = "";
            generatedQuestions.forEach((q, index) => { interviewTranscript += `Q: ${q}\nA: ${document.getElementById(`answer_${index}`).value}\n`; });
            els.interviewModal.classList.remove('show'); setLoading(true, 'Synthesizing persona...');

            try {
                const fullPrompt = `Create a BUYER PERSONA based on: ${els.websiteUrl.value} and ${interviewTranscript}.
IF SERVICE: Focus on 7Ps, Trust, Outreach. IF PRODUCT: Focus on 4Ps, Visuals, Ads.`;
                const personaText = await callGeminiAPI(apiKey, fullPrompt, null);
                customPersona = personaText; displayPersona(personaText);
                localStorage.setItem('customPersona', personaText); localStorage.setItem('personaWebsite', els.websiteUrl.value);
                els.personaInputSection.style.display = 'none'; els.personaSection.style.display = 'block';
                els.resetPersonaBtn.style.display = 'inline-block'; els.configPanel.classList.add('collapsed'); showToast('‚úÖ Persona Generated!');
            } catch(err) { showToast('Error: ' + err.message); } finally { setLoading(false); els.generatePersonaBtn.disabled = false; }
        }

        async function analyzeImage() {
            const apiKey = els.apiKey.value.trim();
            if(!apiKey || !imageBase64) return showToast('Check API Key & Image');
            els.configPanel.classList.add('collapsed'); setLoading(true, 'Starting analysis...');
            els.resultsSection.style.display = 'none'; els.analyzeBtn.disabled = true;

            try {
                const pContext = customPersona ? `\nBRAND PERSONA:\n${customPersona}\n` : '';
                const prompts = {
                    calendar: pContext + `Create a 30-Day Marketing Calendar Table (Day, Channel, Type, Topic, Goal). IF SERVICE: Mid-week/Webinars. IF PRODUCT: Weekend/Ads.`,
                    story: pContext + `Robert McKee Story (800 words).`,
                    marketing: pContext + `Copywriting (PAS Framework).`,
                    instagram: pContext + `5 Instagram Captions.`,
                    blog: pContext + `SEO Blog Post.`,
                    googleads: pContext + `Google Ads.`,
                    podcast: pContext + `Podcast Script.`,
                    aeo: pContext + `AEO Audit.`
                };

                setLoading(true, 'Generating Calendar...');
                generatedContent.calendar = await callGeminiAPI(apiKey, prompts.calendar, imageBase64);

                const tasks = parseMarkdownTable(generatedContent.calendar);
                if (tasks.length > 0) { campaignTasks = tasks; saveTrackerState(); }

                for (const [key, prompt] of Object.entries(prompts)) {
                    if (key === 'calendar') continue;
                    setLoading(true, `Generating ${key}...`);
                    generatedContent[key] = await callGeminiAPI(apiKey, prompt, imageBase64);
                    await new Promise(r => setTimeout(r, 1200)); 
                }

                els.resultsSection.style.display = 'block';
                document.querySelector('[data-tab="tracker"]').click();
                els.resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                showToast('‚úÖ Campaign Generated!');
            } catch(err) { showToast('Error: ' + err.message); } finally { setLoading(false); els.analyzeBtn.disabled = false; }
        }

        async function callGeminiAPI(apiKey, prompt, imageBase64 = null) {
            if (workingModel) return executeGeneration(apiKey, workingModel, prompt, imageBase64);
            try {
                const listResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const listData = await listResp.json();
                let candidates = (listData.models || []).filter(m => m.supportedGenerationMethods?.includes('generateContent'))
                    .sort((a, b) => (b.name.includes('gemini-2') ? 1 : 0) - (a.name.includes('gemini-2') ? 1 : 0));
                if (!candidates.length) candidates = [{ name: 'models/gemini-2.0-flash' }, { name: 'models/gemini-1.5-flash' }];

                for (const candidate of candidates) {
                    try {
                        const mName = candidate.name.replace('models/', '');
                        const res = await executeGeneration(apiKey, mName, prompt, imageBase64);
                        workingModel = mName; return res;
                    } catch (e) {}
                }
                throw new Error('No models worked.');
            } catch (e) { return fallbackHardcodedGeneration(apiKey, prompt, imageBase64); }
        }

        async function executeGeneration(apiKey, modelName, prompt, imageBase64) {
            const parts = [{ text: prompt }];
            if(imageBase64) parts.push({ inline_data: { mime_type: selectedFile.type, data: imageBase64 } });
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts }], generationConfig: { temperature: 0.9, topK: 40, topP: 0.95, maxOutputTokens: 8192 } })
            });
            if(!response.ok) throw new Error((await response.json()).error?.message || 'API Error');
            return (await response.json()).candidates[0].content.parts[0].text;
        }

        async function fallbackHardcodedGeneration(apiKey, prompt, imageBase64) {
             for (const m of ['gemini-2.0-flash', 'gemini-1.5-flash']) { try { return await executeGeneration(apiKey, m, prompt, imageBase64); } catch (e) {} }
             throw new Error("All models failed.");
        }

        function displayPersona(text) { els.personaContent.innerHTML = marked.parse(text); }
        function setLoading(isLoading, text = '') {
            els.loading.style.display = isLoading ? 'block' : 'none';
            if(isLoading) { els.uploadArea.style.display = 'none'; els.previewContainer.style.display = 'none'; els.analyzeBtn.style.display = 'none'; els.loadingText.innerText = text; }
            else if(imageBase64) { els.previewContainer.style.display = 'block'; els.analyzeBtn.style.display = 'flex'; }
            else els.uploadArea.style.display = 'block';
        }
        function showToast(msg) { els.toast.innerText = msg; els.toast.classList.add('show'); setTimeout(() => els.toast.classList.remove('show'), 3000); }
        function copyCurrentContent() { navigator.clipboard.writeText(els.activeContent.innerText).then(() => showToast('üìã Copied!')); }

        function exportCurrentToPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            let cursorY = 20; const margin = 20; const pageHeight = doc.internal.pageSize.getHeight();
            doc.setFontSize(16); doc.text(els.contentTitle.innerText, margin, cursorY); cursorY += 15;

            if (activeTab === 'tracker') {
                doc.setFontSize(14); doc.text(`Status Report: ${Math.round(campaignTasks.filter(t=>t.status==='done').length/campaignTasks.length*100)}% Complete`, margin, cursorY); cursorY += 10;
                doc.setFontSize(10);
                campaignTasks.forEach(t => {
                    const statusIcon = t.status==='done' ? '[DONE]' : t.status==='doing' ? '[IN PROGRESS]' : '[TODO]';
                    const text = `${statusIcon} ${t.day}: ${t.topic}
   Notes: ${t.notes || 'None'}`;
                    const split = doc.splitTextToSize(text, 170);
                    if (cursorY + (split.length * 5) > pageHeight - 20) { doc.addPage(); cursorY = 20; }
                    doc.text(split, margin, cursorY); cursorY += (split.length * 5) + 5;
                });
            } else {
                // ... Existing image/text export logic ...
                const content = els.activeContent.innerText;
                const splitText = doc.splitTextToSize(content, 170);
                splitText.forEach(line => { if (cursorY > pageHeight - 20) { doc.addPage(); cursorY = 20; } doc.text(line, margin, cursorY); cursorY += 6; });
            }
            doc.save(`${activeTab}_export.pdf`); showToast('üìÑ PDF exported!');
        }

        function exportPersonaToPDF() { /* ... existing ... */ }
    </script>
</body>
</html>